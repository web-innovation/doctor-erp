// DocClinic ERP Database Schema
// SQLite is the default provider (development and production single-node fallback)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  phone         String    @unique
  password      String
  name          String
  role          String    @default("STAFF") // SUPER_ADMIN, DOCTOR, RECEPTIONIST, PHARMACIST, ACCOUNTANT, STAFF
  isActive      Boolean   @default(true)
  avatar        String?
  preferences   String?   // JSON string for dashboard preferences
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clinic        Clinic?   @relation(fields: [clinicId], references: [id])
  clinicId      String?
  staffProfile  Staff?
  sessions      Session[]
  auditLogs     AuditLog[]

  @@index([clinicId])
  @@index([phone])
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  device    String?
  ipAddress String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@index([userId])
}

// ==========================================
// CLINIC CONFIGURATION
// ==========================================

model Clinic {
  id            String   @id @default(uuid())
  name          String
  logo          String?
  address       String
  city          String
  state         String
  pincode       String
  phone         String
  email         String?
  website       String?
  gstNumber     String?
  licenseNumber String?
  taxConfig     String?  // JSON string
  workingHours  String?  // JSON string
  slotDuration  Int      @default(15)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users         User[]
  staff         Staff[]
  patients      Patient[]
  appointments  Appointment[]
  prescriptions Prescription[]
  bills         Bill[]
  pharmacy      PharmacyProduct[]
  labs          Lab[]
  agents        Agent[]
  payments      Payment[]
}

// ==========================================
// STAFF MANAGEMENT
// ==========================================

model Staff {
  id               String   @id @default(uuid())
  employeeId       String   @unique
  designation      String
  department       String?
  joinDate         DateTime
  salary           Float
  bankAccount      String?
  panNumber        String?
  aadharNumber     String?
  address          String?
  emergencyContact String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id])
  userId           String   @unique
  clinic           Clinic   @relation(fields: [clinicId], references: [id])
  clinicId         String
  attendance       Attendance[]
  leaves           Leave[]

  @@index([clinicId])
}

model Attendance {
  id          String   @id @default(uuid())
  date        DateTime
  checkIn     DateTime?
  checkOut    DateTime?
  status      String   @default("PRESENT") // PRESENT, ABSENT, HALF_DAY, LATE, ON_LEAVE
  notes       String?
  hoursWorked Float?
  
  createdAt   DateTime @default(now())

  staff       Staff    @relation(fields: [staffId], references: [id])
  staffId     String

  @@unique([staffId, date])
  @@index([date])
}

model Leave {
  id          String    @id @default(uuid())
  startDate   DateTime
  endDate     DateTime
  type        String    // CASUAL, SICK, EARNED, UNPAID, MATERNITY, PATERNITY
  reason      String
  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  approvedBy  String?
  approvedAt  DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  staff       Staff     @relation(fields: [staffId], references: [id])
  staffId     String

  @@index([staffId])
  @@index([status])
}

// ==========================================
// PATIENT MANAGEMENT
// ==========================================

model Patient {
  id               String   @id @default(uuid())
  patientId        String   @unique // Custom ID like P-0001
  name             String
  phone            String
  email            String?
  gender           String   // MALE, FEMALE, OTHER
  dateOfBirth      DateTime?
  age              Int?
  bloodGroup       String?
  address          String?
  city             String?
  emergencyContact String?
  allergies        String?  // JSON array string
  medicalHistory   String?  // JSON string
  insurance        String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  clinic           Clinic   @relation(fields: [clinicId], references: [id])
  clinicId         String
  appointments     Appointment[]
  prescriptions    Prescription[]
  bills            Bill[]
  vitals           PatientVital[]

  @@index([clinicId])
  @@index([phone])
  @@index([patientId])
}

model PatientVital {
  id            String   @id @default(uuid())
  recordedAt    DateTime @default(now())
  weight        Float?
  height        Float?
  bloodPressure String?
  pulse         Int?
  temperature   Float?
  spO2          Int?
  bloodSugar    Float?
  notes         String?

  patient       Patient  @relation(fields: [patientId], references: [id])
  patientId     String

  @@index([patientId])
  @@index([recordedAt])
}

// ==========================================
// APPOINTMENTS & OPD
// ==========================================

model Appointment {
  id              String   @id @default(uuid())
  appointmentNo   String   @unique
  date            DateTime
  timeSlot        String
  type            String   @default("CONSULTATION") // CONSULTATION, FOLLOW_UP, EMERGENCY, LAB_TEST, PROCEDURE
  status          String   @default("SCHEDULED") // SCHEDULED, CONFIRMED, IN_QUEUE, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW
  symptoms        String?
  notes           String?
  consultationFee Float?
  bookedVia       String?
  confirmedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  patient         Patient  @relation(fields: [patientId], references: [id])
  patientId       String
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  clinicId        String
  prescription    Prescription?

  @@index([clinicId, date])
  @@index([patientId])
  @@index([status])
}

// ==========================================
// PRESCRIPTIONS
// ==========================================

model Prescription {
  id              String   @id @default(uuid())
  prescriptionNo  String   @unique
  date            DateTime @default(now())
  diagnosis       String?  // JSON array string
  symptoms        String?  // JSON array string
  clinicalNotes   String?
  advice          String?
  followUpDate    DateTime?
  vitalsSnapshot  String?  // JSON string
  pdfUrl          String?
  sentViaWhatsApp Boolean  @default(false)
  sentViaEmail    Boolean  @default(false)
  sentAt          DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  patient         Patient  @relation(fields: [patientId], references: [id])
  patientId       String
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  clinicId        String
  appointment     Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId   String?  @unique
  medicines       PrescriptionMedicine[]
  labTests        PrescriptionLabTest[]

  @@index([clinicId])
  @@index([patientId])
  @@index([date])
}

model PrescriptionMedicine {
  id            String   @id @default(uuid())
  medicineName  String
  genericName   String?
  dosage        String
  frequency     String
  duration      String
  timing        String?
  quantity      Int
  instructions  String?
  
  prescription  Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  prescriptionId String
  pharmacyProduct PharmacyProduct? @relation(fields: [productId], references: [id])
  productId     String?

  @@index([prescriptionId])
}

model PrescriptionLabTest {
  id            String   @id @default(uuid())
  testName      String
  instructions  String?
  
  prescription  Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  prescriptionId String
  lab           Lab?     @relation(fields: [labId], references: [id])
  labId         String?

  @@index([prescriptionId])
}

// ==========================================
// PHARMACY MANAGEMENT
// ==========================================

model PharmacyProduct {
  id            String   @id @default(uuid())
  code          String
  name          String
  genericName   String?
  manufacturer  String?
  category      String
  mrp           Float
  purchasePrice Float
  sellingPrice  Float
  gstPercent    Float    @default(12)
  quantity      Int      @default(0)
  minStock      Int      @default(10)
  unit          String   @default("pcs")
  batchNumber   String?
  expiryDate    DateTime?
  rackNumber    String?
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clinic        Clinic   @relation(fields: [clinicId], references: [id])
  clinicId      String
  stockHistory  StockHistory[]
  prescriptions PrescriptionMedicine[]
  billItems     BillItem[]

  @@unique([clinicId, code])
  @@index([clinicId])
  @@index([name])
  @@index([quantity])
}

model StockHistory {
  id            String   @id @default(uuid())
  type          String   // PURCHASE, SALE, ADJUSTMENT, RETURN, EXPIRED, DAMAGED
  quantity      Int
  previousQty   Int
  newQty        Int
  reference     String?
  notes         String?
  updatedVia    String?
  billImageUrl  String?
  
  createdAt     DateTime @default(now())
  createdBy     String?

  product       PharmacyProduct @relation(fields: [productId], references: [id])
  productId     String

  @@index([productId])
  @@index([createdAt])
}

// ==========================================
// BILLING
// ==========================================

model Bill {
  id              String   @id @default(uuid())
  billNo          String   @unique
  date            DateTime @default(now())
  type            String   // CONSULTATION, PHARMACY, LAB_TEST, PROCEDURE, MIXED
  subtotal        Float
  discountPercent Float?
  discountAmount  Float?
  taxAmount       Float
  totalAmount     Float
  paidAmount      Float    @default(0)
  dueAmount       Float
  taxBreakdown    String?  // JSON string
  paymentStatus   String   @default("PENDING") // PENDING, PARTIAL, PAID, REFUNDED
  paymentMethod   String?
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  patient         Patient? @relation(fields: [patientId], references: [id])
  patientId       String?
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  clinicId        String
  items           BillItem[]
  payments        Payment[]
  labCommission   Lab?     @relation(fields: [labId], references: [id])
  labId           String?
  agentCommission Agent?   @relation(fields: [agentId], references: [id])
  agentId         String?

  @@index([clinicId])
  @@index([patientId])
  @@index([date])
  @@index([paymentStatus])
}

model BillItem {
  id          String   @id @default(uuid())
  description String
  quantity    Int
  unitPrice   Float
  gstPercent  Float    @default(0)
  amount      Float

  bill        Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  billId      String
  product     PharmacyProduct? @relation(fields: [productId], references: [id])
  productId   String?

  @@index([billId])
}

// ==========================================
// PAYMENTS & COLLECTIONS
// ==========================================

model Payment {
  id          String    @id @default(uuid())
  amount      Float
  method      String
  reference   String?
  imageUrl    String?
  parsedData  String?   // JSON string
  verifiedAt  DateTime?
  verifiedBy  String?
  notes       String?
  receivedAt  DateTime  @default(now())
  
  createdAt   DateTime  @default(now())

  bill        Bill?     @relation(fields: [billId], references: [id])
  billId      String?
  clinic      Clinic    @relation(fields: [clinicId], references: [id])
  clinicId    String

  @@index([clinicId])
  @@index([receivedAt])
}

// ==========================================
// LABS & AGENTS (Commission Management)
// ==========================================

model Lab {
  id              String   @id @default(uuid())
  name            String
  address         String?
  phone           String?
  email           String?
  contactPerson   String?
  commissionType  String   @default("PERCENTAGE") // PERCENTAGE, FIXED
  commissionValue Float
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  clinicId        String
  bills           Bill[]
  commissions     CommissionRecord[]
  labTests        PrescriptionLabTest[]

  @@index([clinicId])
}

model Agent {
  id              String   @id @default(uuid())
  name            String
  phone           String
  email           String?
  address         String?
  commissionType  String   @default("PERCENTAGE")
  commissionValue Float
  discountAllowed Float    @default(0)
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  clinicId        String
  bills           Bill[]
  commissions     CommissionRecord[]

  @@index([clinicId])
}

model CommissionRecord {
  id         String    @id @default(uuid())
  amount     Float
  billAmount Float
  rate       Float
  status     String    @default("PENDING") // PENDING, PAID, CANCELLED
  paidAt     DateTime?
  
  createdAt  DateTime  @default(now())

  lab        Lab?      @relation(fields: [labId], references: [id])
  labId      String?
  agent      Agent?    @relation(fields: [agentId], references: [id])
  agentId    String?

  @@index([labId])
  @@index([agentId])
  @@index([status])
}

// ==========================================
// AUDIT & LOGGING
// ==========================================

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String?
  oldData   String?  // JSON string
  newData   String?  // JSON string
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// WHATSAPP BOT SESSIONS
// ==========================================

model WhatsAppSession {
  id          String   @id @default(uuid())
  phone       String   @unique
  context     String?  // JSON string
  lastMessage DateTime @default(now())
  userId      String?
  role        String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phone])
}

// ==========================================
// EMAIL NOTIFICATIONS (OAuth2)
// ==========================================

model EmailLog {
  id             String    @id @default(uuid())
  recipientEmail String
  subject        String
  type           String    // appointment_reminder, prescription, bill, password_reset, welcome, test
  status         String    @default("sent") // sent, failed
  messageId      String?
  error          String?
  
  sentAt         DateTime  @default(now())
  
  userId         String?
  patientId      String?
  
  @@index([type])
  @@index([status])
  @@index([sentAt])
  @@index([recipientEmail])
}

model ClinicSettings {
  id        String   @id @default(uuid())
  key       String
  value     String   // JSON string for complex values
  
  clinicId  String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clinicId, key])
  @@index([key])
}
