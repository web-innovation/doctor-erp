import{u as Te,U as De,J as Ue,r as s,j as t,z as b}from"./index-DmpGw-cD.js";import{l as I}from"./ledgerService-Cdtj2TAW.js";import{p as ve}from"./pharmacyService-CYnTKkh_.js";import{p as Ne}from"./purchaseService-q9Y-mIg8.js";const Q=["PURCHASE","RETURN"],Re=["PURCHASE","RETURN","PAYMENT"];function $e(){const Y=Te(),T=De(),je=Ue("ledger:create"),[o,B]=s.useState("JOURNAL"),[D,fe]=s.useState("CASH"),[C,y]=s.useState(""),[w,v]=s.useState(""),[U,X]=s.useState(""),[H,Pe]=s.useState(""),[K,Se]=s.useState(""),[A,Z]=s.useState(""),[ee,R]=s.useState([]),[te,ae]=s.useState(null),[k,re]=s.useState(""),[se,O]=s.useState([]),[ne,le]=s.useState(null),[z,N]=s.useState(!0),[_,j]=s.useState(!0),[ce,f]=s.useState(""),[E,ie]=s.useState(""),[oe,F]=s.useState([]),[c,q]=s.useState(null),[ue,G]=s.useState(!1),[J,de]=s.useState(""),[me,$]=s.useState(""),[P,p]=s.useState([]),[M,pe]=s.useState(""),[he,L]=s.useState([]),[xe,V]=s.useState(!1),[n,x]=s.useState({name:"",mrp:"",purchasePrice:"",sellingPrice:"",gstPercent:"",sku:"",category:"",initialStock:""}),[ge,W]=s.useState("");s.useEffect(()=>{if(!A)return R([]);const e=setTimeout(async()=>{var a;try{const r=await I.getAccounts(A);R(((a=r.data)==null?void 0:a.data)||[])}catch{R([])}},250);return()=>clearTimeout(e)},[A]),s.useEffect(()=>{if(!k)return O([]);const e=setTimeout(async()=>{var a;try{const r=await I.getAccounts(k);O(((a=r.data)==null?void 0:a.data)||[])}catch{O([])}},250);return()=>clearTimeout(e)},[k]),s.useEffect(()=>{if(!M)return L([]);const e=setTimeout(async()=>{var a;try{const r=await ve.getProducts({search:M,limit:10});L(((a=r==null?void 0:r.data)==null?void 0:a.data)||(r==null?void 0:r.data)||[])}catch{L([])}},250);return()=>clearTimeout(e)},[M]),s.useEffect(()=>{if(!E)return F([]);const e=setTimeout(async()=>{var a;try{const r=await Ne.getSuppliers(E);F(((a=r==null?void 0:r.data)==null?void 0:a.data)||(r==null?void 0:r.data)||[])}catch{F([])}},250);return()=>clearTimeout(e)},[E]),s.useEffect(()=>{const e=P.reduce((u,l)=>u+Number(l.unitPrice||0)*Number(l.quantity||0),0),a=P.reduce((u,l)=>u+Number(l.unitPrice||0)*Number(l.quantity||0)*(Number(l.gstPercent||0)/100),0),r=e+a;if(Q.includes(o)&&X(String(Number(r.toFixed(2)))),o==="PURCHASE"){y("Inventory"),v(c!=null&&c.name?`Payable - ${c.name}`:"Accounts Payable"),N(!1),j(!1);return}if(o==="RETURN"){y(c!=null&&c.name?`Payable - ${c.name}`:"Accounts Payable"),v("Inventory"),N(!1),j(!1);return}if(o==="PAYMENT"){y(c!=null&&c.name?`Payable - ${c.name}`:"Accounts Payable"),v(D==="BANK"?"Bank":D==="UPI"?"UPI":"Cash"),N(!1),j(!1);return}if(o==="ADJUSTMENT"){C||y("Inventory"),w||v("Inventory Adjustment"),N(!0),j(!0);return}N(!0),j(!0)},[o,P,c,D,C,w]),s.useEffect(()=>{const e=T==null?void 0:T.state;e&&(e.mode&&B(e.mode),Array.isArray(e.items)&&e.items.length&&p(e.items.map(a=>({productId:a.productId,name:a.name,quantity:Number(a.quantity||1),unitPrice:Number(a.unitPrice||0),gstPercent:Number(a.gstPercent||0),batchNumber:a.batchNumber||"",expiryDate:a.expiryDate||""}))),e.supplierName&&f(e.supplierName))},[T]),s.useEffect(()=>{try{const e=localStorage.getItem("manualPrefill");if(!e)return;const a=JSON.parse(e);a.mode&&B(a.mode),Array.isArray(a.items)&&a.items.length&&p(a.items),a.supplierName&&f(a.supplierName),localStorage.removeItem("manualPrefill")}catch{}},[]);const Ce=async()=>{var a,r,u;const e=J==null?void 0:J.trim();if($(""),!e)return $("Enter supplier name");try{const l=await Ne.createSupplier({name:e}),d=((a=l.data)==null?void 0:a.data)||l.data||l;q(d),f(d.name),de(""),G(!1),b.success("Supplier created")}catch(l){b.error(((u=(r=l.response)==null?void 0:r.data)==null?void 0:u.message)||"Failed to create supplier")}},we=async()=>{var e,a,r;if(W(""),!n.name||!n.mrp){W("Provide product name and MRP");return}try{const u={name:n.name,code:n.sku||void 0,category:n.category||"medicine",mrp:parseFloat(n.mrp),sellingPrice:n.sellingPrice?parseFloat(n.sellingPrice):parseFloat(n.mrp),purchasePrice:n.purchasePrice?parseFloat(n.purchasePrice):parseFloat(n.mrp),gstPercent:n.gstPercent?parseFloat(n.gstPercent):0,quantity:n.initialStock?parseInt(n.initialStock,10):0},l=await ve.createProduct(u),d=((e=l.data)==null?void 0:e.data)||l.data||l;p(S=>[...S,{productId:d.id,name:d.name,quantity:1,unitPrice:d.purchasePrice||d.mrp||0,gstPercent:d.gstPercent||0,batchNumber:"",expiryDate:""}]),V(!1),x({name:"",mrp:"",purchasePrice:"",sellingPrice:"",gstPercent:"",sku:"",category:"",initialStock:""}),b.success("Product created and added")}catch(u){b.error(((r=(a=u.response)==null?void 0:a.data)==null?void 0:r.message)||"Failed to create product")}},be=async(e,a)=>{var l,d,S;if(e!=null&&e.id)return e.id;const r=a==null?void 0:a.trim();if(!r)return null;const u=await I.createAccount({name:r});return((d=(l=u.data)==null?void 0:l.data)==null?void 0:d.id)||((S=u.data)==null?void 0:S.id)||null},Ae=async()=>{if(!te&&!C||!ne&&!w||!U)return b.error("Provide debit, credit and amount"),!1;const e=await be(te,C),a=await be(ne,w),r=o==="PAYMENT"?"PAYMENT":o==="ADJUSTMENT"?"ADJUSTMENT":"MANUAL";return await I.createManualEntry({debitAccountId:e,creditAccountId:a,amount:Number(U),note:H||void 0,date:K||void 0,refType:r}),!0},ke=async()=>Q.includes(o)?P.length===0?(b.error("Add at least one item"),!1):(await I.createManualPurchase({mode:o,supplierId:c==null?void 0:c.id,supplierName:ce||void 0,items:P,note:H||void 0,date:K||void 0}),!0):!1,Ee=async()=>{var e,a;try{if(Q.includes(o)){if(!await ke())return}else if(!await Ae())return;b.success("Manual entry created"),Y("/ledger")}catch(r){b.error(((a=(e=r==null?void 0:r.response)==null?void 0:e.data)==null?void 0:a.message)||"Failed to create manual entry")}};if(!je)return t.jsx("div",{className:"min-h-screen p-6",children:t.jsx("div",{className:"max-w-4xl mx-auto bg-white p-6 rounded",children:"You do not have permission to access this page."})});const Me=Re.includes(o),Ie=Q.includes(o),ye=Number(U||0);return t.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:t.jsxs("div",{className:"max-w-5xl mx-auto bg-white rounded p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Create Manual Ledger Entry"}),t.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Y("/ledger"),children:"Back"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-sm text-gray-600 bg-yellow-50 border-l-4 border-yellow-300 p-3 rounded",children:"Quick help: pick mode first. Purchases/returns update stock. Payments and adjustments only post ledger entries."}),t.jsxs("div",{children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Mode"}),t.jsxs("select",{value:o,onChange:e=>B(e.target.value),className:"p-2 border rounded w-full",children:[t.jsx("option",{value:"JOURNAL",children:"Journal (debit/credit)"}),t.jsx("option",{value:"PURCHASE",children:"Manual Purchase (add stock)"}),t.jsx("option",{value:"RETURN",children:"Manual Return (reduce stock)"}),t.jsx("option",{value:"PAYMENT",children:"Supplier Payment"}),t.jsx("option",{value:"ADJUSTMENT",children:"Adjustment Entry"})]})]}),Me&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Supplier / Distributor"}),t.jsxs("div",{className:"relative",children:[t.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Supplier name",value:c?c.name:E||ce,onChange:e=>{ie(e.target.value),f(e.target.value),q(null)}}),oe.length>0&&E&&t.jsx("div",{className:"absolute z-30 bg-white border rounded mt-1 w-full max-h-48 overflow-auto",children:oe.map(e=>t.jsxs("div",{className:"p-2 hover:bg-gray-50 cursor-pointer",onClick:()=>{q(e),f(e.name),ie(""),F([])},children:[e.name," ",e.phone?`- ${e.phone}`:""]},e.id))}),t.jsxs("div",{className:"mt-2 flex gap-2",children:[t.jsx("button",{className:"px-2 py-1 text-sm border rounded",onClick:()=>{G(e=>!e),$("")},children:ue?"Close":"Create supplier"}),c&&t.jsx("button",{className:"px-2 py-1 text-sm border rounded",onClick:()=>{q(null),f("")},children:"Clear"})]}),ue&&t.jsxs("div",{className:"mt-3 p-3 border rounded bg-gray-50",children:[t.jsx("div",{className:"text-sm font-medium",children:"Create supplier"}),t.jsx("input",{className:"mt-2 p-2 border w-full",value:J,onChange:e=>{de(e.target.value),$("")},placeholder:"Supplier name"}),me&&t.jsx("div",{className:"text-sm text-red-600 mt-2",children:me}),t.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[t.jsx("button",{className:"px-2 py-1 border rounded",onClick:()=>G(!1),children:"Cancel"}),t.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded",onClick:Ce,children:"Create"})]})]})]})]}),o==="PAYMENT"&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Payment Method"}),t.jsxs("select",{className:"p-2 border rounded w-full",value:D,onChange:e=>fe(e.target.value),children:[t.jsx("option",{value:"CASH",children:"Cash"}),t.jsx("option",{value:"BANK",children:"Bank"}),t.jsx("option",{value:"UPI",children:"UPI"})]})]}),Ie&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Add product"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{className:"flex-1 p-2 border rounded",placeholder:"Search medicine",value:M,onChange:e=>pe(e.target.value)}),t.jsx("button",{className:"px-2 py-1 border rounded",onClick:()=>{V(e=>!e),W("")},children:xe?"Close":"New"})]}),he.length>0&&M&&t.jsx("div",{className:"border bg-white max-h-44 overflow-auto mt-1",children:he.map(e=>t.jsxs("div",{className:"p-2 hover:bg-gray-50 cursor-pointer",onClick:()=>{p(a=>[...a,{productId:e.id,name:e.name,quantity:1,unitPrice:e.purchasePrice||e.mrp||0,gstPercent:e.gstPercent||0,batchNumber:"",expiryDate:""}]),pe(""),L([])},children:[e.name," - ",e.code||""]},e.id))})]}),xe&&t.jsxs("div",{className:"mt-3 p-3 border rounded bg-gray-50",children:[t.jsx("div",{className:"text-sm font-medium",children:"Create product"}),ge&&t.jsx("div",{className:"text-sm text-red-600 mt-2",children:ge}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2",children:[t.jsx("input",{className:"p-2 border",placeholder:"Name",value:n.name,onChange:e=>x(a=>({...a,name:e.target.value}))}),t.jsx("input",{className:"p-2 border",placeholder:"SKU (optional)",value:n.sku,onChange:e=>x(a=>({...a,sku:e.target.value}))}),t.jsx("input",{className:"p-2 border",placeholder:"MRP",value:n.mrp,onChange:e=>x(a=>({...a,mrp:e.target.value}))}),t.jsx("input",{className:"p-2 border",placeholder:"Purchase Price",value:n.purchasePrice,onChange:e=>x(a=>({...a,purchasePrice:e.target.value}))}),t.jsx("input",{className:"p-2 border",placeholder:"Selling Price",value:n.sellingPrice,onChange:e=>x(a=>({...a,sellingPrice:e.target.value}))}),t.jsx("input",{className:"p-2 border",placeholder:"GST %",value:n.gstPercent,onChange:e=>x(a=>({...a,gstPercent:e.target.value}))}),t.jsx("input",{className:"p-2 border col-span-2",placeholder:"Category",value:n.category,onChange:e=>x(a=>({...a,category:e.target.value}))}),t.jsx("input",{className:"p-2 border col-span-2",placeholder:"Initial Stock (optional)",value:n.initialStock,onChange:e=>x(a=>({...a,initialStock:e.target.value}))})]}),t.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[t.jsx("button",{className:"px-2 py-1 border rounded",onClick:()=>V(!1),children:"Cancel"}),t.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded",onClick:we,children:"Create and Add"})]})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Items"}),t.jsx("div",{className:"space-y-2",children:P.map((e,a)=>{const r=Number(e.quantity||0),u=Number(e.unitPrice||0),l=Number(e.gstPercent||0),d=r*u,S=d*(l/100);return t.jsxs("div",{className:"flex gap-2 items-center",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{children:e.name}),t.jsxs("div",{className:"flex gap-2 mt-1",children:[t.jsx("input",{"aria-label":`batch-${a}`,placeholder:"Batch",className:"p-1 border rounded w-36",value:e.batchNumber||"",onChange:m=>p(h=>h.map((i,g)=>g===a?{...i,batchNumber:m.target.value}:i))}),t.jsx("input",{"aria-label":`expiry-${a}`,type:"date",className:"p-1 border rounded w-36",value:e.expiryDate||"",onChange:m=>p(h=>h.map((i,g)=>g===a?{...i,expiryDate:m.target.value}:i))})]})]}),t.jsx("input",{"aria-label":`quantity-${a}`,type:"number",min:1,className:"w-20 p-1 border rounded text-right",value:e.quantity,onChange:m=>p(h=>h.map((i,g)=>g===a?{...i,quantity:Number(m.target.value)}:i))}),t.jsx("input",{"aria-label":`rate-${a}`,type:"number",step:"0.01",className:"w-28 p-1 border rounded text-right",value:e.unitPrice,onChange:m=>p(h=>h.map((i,g)=>g===a?{...i,unitPrice:Number(m.target.value)}:i))}),t.jsx("input",{"aria-label":`gst-${a}`,type:"number",step:"0.01",className:"w-20 p-1 border rounded text-right",value:e.gstPercent,onChange:m=>p(h=>h.map((i,g)=>g===a?{...i,gstPercent:Number(m.target.value)}:i))}),t.jsx("div",{className:"w-28 text-right text-sm text-gray-700",children:new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(d+S)}),t.jsx("button",{className:"px-2 py-1 text-sm bg-red-100 rounded",onClick:()=>p(m=>m.filter((h,i)=>i!==a)),children:"Remove"})]},a)})})]})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-baseline justify-between",children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Debit account"}),t.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-2",children:["Auto-selected for guided modes",t.jsx("button",{type:"button",className:"text-xs text-blue-600",onClick:()=>N(e=>!e),children:z?"Edit":"Lock"})]})]}),t.jsx("input",{readOnly:!z,className:`w-full p-2 border rounded ${z?"":"bg-gray-100"}`,placeholder:"Search debit account",value:A||C,onChange:e=>{Z(e.target.value),y(e.target.value),ae(null)}}),ee.length>0&&A&&t.jsx("div",{className:"border bg-white max-h-44 overflow-auto mt-1",children:ee.map(e=>t.jsx("div",{className:"p-2 hover:bg-gray-50 cursor-pointer",onClick:()=>{ae(e),Z(e.name),y(e.name),R([])},children:e.name},e.id))})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-baseline justify-between",children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Credit account"}),t.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-2",children:["Auto-selected for guided modes",t.jsx("button",{type:"button",className:"text-xs text-blue-600",onClick:()=>j(e=>!e),children:_?"Edit":"Lock"})]})]}),t.jsx("input",{readOnly:!_,className:`w-full p-2 border rounded ${_?"":"bg-gray-100"}`,placeholder:"Search credit account",value:k||w,onChange:e=>{re(e.target.value),v(e.target.value),le(null)}}),se.length>0&&k&&t.jsx("div",{className:"border bg-white max-h-44 overflow-auto mt-1",children:se.map(e=>t.jsx("div",{className:"p-2 hover:bg-gray-50 cursor-pointer",onClick:()=>{le(e),re(e.name),v(e.name),O([])},children:e.name},e.id))})]}),t.jsxs("div",{className:"text-sm text-gray-500 mt-1",children:["Suggested mapping:",t.jsxs("ul",{className:"list-disc ml-5",children:[t.jsxs("li",{children:[t.jsx("strong",{children:"Purchase:"})," Debit Inventory, Credit Payable - Supplier"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Return:"})," Debit Payable - Supplier, Credit Inventory"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Payment:"})," Debit Payable - Supplier, Credit Cash/Bank/UPI"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Adjustment:"})," Uses refType ADJUSTMENT for audit clarity"]})]})]}),t.jsxs("div",{children:[t.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Amount",type:"number",value:U,onChange:e=>X(e.target.value)}),t.jsx("input",{className:"w-full p-2 border rounded mt-2",placeholder:"Date (optional)",type:"date",value:K,onChange:e=>Se(e.target.value)}),t.jsx("textarea",{className:"w-full p-2 border rounded mt-2",placeholder:"Note (optional)",value:H,onChange:e=>Pe(e.target.value)}),ye>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Amount preview: ",new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(ye)]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>Y("/ledger"),children:"Cancel"}),t.jsx("button",{className:"px-3 py-1 bg-green-600 text-white rounded",onClick:Ee,children:"Create"})]})]})]})})}export{$e as default};
