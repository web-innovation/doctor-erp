import{T as ut,J as Me,j as e,u as mt,r as x,b as bt,ac as xt,p as D,a as pt,I as gt,l as ht,g as ft,K as Te,al as Oe,y as yt,ae as jt,am as Nt,af as vt,z as w,an as Be,D as $e}from"./index-CfZ_Qhs7.js";import{u as _e}from"./useMutation-Cv6kCchT.js";import{b as U}from"./billingService-DAC3OcEb.js";import{p as Pt}from"./pharmacyService-Dz2-9iFY.js";const wt=[{id:"consultation",label:"Consultation",color:"blue"},{id:"pharmacy",label:"Pharmacy",color:"green"},{id:"lab",label:"Lab Test",color:"purple"}],Tt=[{value:0,label:"No GST (0%)"},{value:5,label:"GST 5%"},{value:10,label:"GST 10%"},{value:12,label:"GST 12%"},{value:18,label:"GST 18%"},{value:20,label:"GST 20%"},{value:30,label:"GST 30%"}],St=[{value:"cash",label:"Cash"},{value:"card",label:"Card"},{value:"upi",label:"UPI"},{value:"netbanking",label:"Net Banking"},{value:"insurance",label:"Insurance"}];function kt(){var Ee;const{id:T}=ut(),Ue=Me("billing:create",["SUPER_ADMIN","DOCTOR","ACCOUNTANT","PHARMACIST","RECEPTIONIST"]),ze=Me("billing:edit",["SUPER_ADMIN","DOCTOR","ACCOUNTANT","PHARMACIST","RECEPTIONIST"]),z=!!T;if(z&&!ze||!z&&!Ue)return e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 border border-gray-100",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Access denied"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["You do not have permission to ",z?"edit":"create"," bills."]})]})})});const J=mt(),[V,oe]=x.useState(""),[N,X]=x.useState(null),[Se,W]=x.useState(!1),[u,K]=x.useState("consultation"),[Z,Ae]=x.useState(""),[Ce,ee]=x.useState(!1),[M,ie]=x.useState(""),[y,Ke]=x.useState(null),[H,Ie]=x.useState(""),[He,de]=x.useState(!1),[ue,Qe]=x.useState(!1),{register:m,control:Ye,handleSubmit:Je,watch:j,setValue:c,formState:{errors:At}}=bt({defaultValues:{items:[],discount:0,discountType:"fixed",gstRate:0,paymentMethod:"cash",paymentAmount:0,paymentReference:"",notes:"",defaultConsultationGstPercent:5,defaultPharmacyGstPercent:10,defaultLabTestGstPercent:20,defaultConsultationDiscountPercent:0,defaultPharmacyDiscountPercent:0,defaultLabTestDiscountPercent:0}}),Ve=()=>e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Module GST & Discount Defaults"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Consultation GST (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m("defaultConsultationGstPercent"),className:"input input-bordered w-full mb-2"}),e.jsx("label",{className:"block text-xs mb-1",children:"Consultation Discount (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m("defaultConsultationDiscountPercent"),className:"input input-bordered w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Pharmacy GST (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m("defaultPharmacyGstPercent"),className:"input input-bordered w-full mb-2"}),e.jsx("label",{className:"block text-xs mb-1",children:"Pharmacy Discount (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m("defaultPharmacyDiscountPercent"),className:"input input-bordered w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Lab Test GST (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m("defaultLabTestGstPercent"),className:"input input-bordered w-full mb-2"}),e.jsx("label",{className:"block text-xs mb-1",children:"Lab Test Discount (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m("defaultLabTestDiscountPercent"),className:"input input-bordered w-full"})]})]})]}),{fields:te,append:me,remove:Xe,replace:We}=xt({control:Ye,name:"items"}),b=j("items")||te,be=j("discount")||0,xe=j("discountType"),O=Number(j("gstRate")||0),B=Number(j("defaultConsultationGstPercent")||0),F=Number(j("defaultPharmacyGstPercent")||0),G=Number(j("defaultLabTestGstPercent")||0),$=Number(j("defaultConsultationDiscountPercent")||0),k=Number(j("defaultPharmacyDiscountPercent")||0),L=Number(j("defaultLabTestDiscountPercent")||0);x.useEffect(()=>{c("gstRate",0)},[c]);const pe=j("paymentAmount")||0,{data:ge}=D({queryKey:["billing-doctors"],queryFn:()=>U.getDoctors(),enabled:!0}),se=(ge==null?void 0:ge.data)||[],[i,ae]=x.useState(null),{user:l,normalizeRole:Ze}=pt(),De=Ze(l==null?void 0:l.role),C=De==="DOCTOR",v=!!(l!=null&&l.isClinicAdmin||["SUPER_ADMIN","ACCOUNTANT"].includes(De)),ne=x.useMemo(()=>{try{const t=Array.isArray(se)?[...se]:[];return C&&l&&(t.some(a=>a.id===l.id)||t.unshift({id:l.id,name:l.name,email:l.email})),t}catch{return se||[]}},[se,C,l]),{data:he}=D({queryKey:["billing-patients-search",V,i==null?void 0:i.id],queryFn:()=>U.getPatients({search:V,limit:10,doctorId:i==null?void 0:i.id}),enabled:V.length>=2}),{data:fe}=D({queryKey:["products-search",Z],queryFn:()=>Pt.getProducts({search:Z,limit:10}),enabled:Z.length>=2&&u==="pharmacy"}),Fe=(he==null?void 0:he.data)||[],Ge=(fe==null?void 0:fe.data)||[],{data:ye}=D({queryKey:["labs-search",M],queryFn:()=>Be.getLabs({search:M,limit:10}),enabled:u==="lab"&&M.length>=1}),ke=(ye==null?void 0:ye.data)||[],{data:je}=D({queryKey:["lab-tests",y==null?void 0:y.id,H],queryFn:()=>Be.getLabTests(y==null?void 0:y.id,{search:H,limit:50}),enabled:u==="lab"&&!!y&&H.length>=1}),Le=(je==null?void 0:je.data)||[],{data:Ne}=D({queryKey:["consultation-fees"],queryFn:()=>$e.getConsultationFees()}),{data:Q}=D({queryKey:["tax-settings"],queryFn:()=>$e.getTaxSettings()}),le=((Ee=Ne==null?void 0:Ne.data)==null?void 0:Ee.fees)||{},ve=t=>Number((le==null?void 0:le[t])||0);x.useEffect(()=>{z||!Q||(c("defaultConsultationGstPercent",Number(Q.consultationGST??0)),c("defaultPharmacyGstPercent",Number(Q.pharmacyGST??0)),c("defaultLabTestGstPercent",Number(Q.labGST??0)))},[z,Q,c]);const S=t=>{const s=String((t==null?void 0:t.type)||"").toLowerCase();return s==="consultation"?"consultation":s==="pharmacy"||s==="medicine"?"pharmacy":s==="lab_test"||s==="lab"?"lab_test":t!=null&&t.productId?"pharmacy":t!=null&&t.labId||t!=null&&t.labTestId?"lab_test":t!=null&&t.doctorId?"consultation":"other"},Re=t=>{const s=S(t);return s==="consultation"?{gstPercent:B,discountPercent:$}:s==="pharmacy"?{gstPercent:F,discountPercent:k}:s==="lab_test"?{gstPercent:G,discountPercent:L}:{gstPercent:O,discountPercent:0}},f=x.useMemo(()=>{const t=b||[],s={consultation:{label:"Consultation",subtotal:0,discount:0,taxable:0,gst:0,total:0},pharmacy:{label:"Pharmacy",subtotal:0,discount:0,taxable:0,gst:0,total:0},lab_test:{label:"Lab Test",subtotal:0,discount:0,taxable:0,gst:0,total:0},other:{label:"Other",subtotal:0,discount:0,taxable:0,gst:0,total:0}},a=t.map(p=>{const d=S(p),Y=Math.max(0,parseFloat(p.quantity)||0),ce=Math.max(0,parseFloat(p.unitPrice)||0),I=Y*ce;let R=parseFloat(p.discountAmount);if(!Number.isFinite(R)||R<0){let E=parseFloat(p.discountPercent);(!Number.isFinite(E)||E<0)&&(d==="consultation"?E=$:d==="pharmacy"?E=k:d==="lab_test"?E=L:E=0),R=I*E/100}R>I&&(R=I);let q=parseFloat(p.gstPercent);(!Number.isFinite(q)||q<0)&&(d==="consultation"?q=B:d==="pharmacy"?q=F:d==="lab_test"?q=G:q=O);const we=Math.max(0,I-R),dt=we*q/100;return s[d].subtotal+=I,s[d].discount+=R,s[d].taxable+=we,s[d].gst+=dt,{moduleType:d,taxableBeforeGlobal:we}}),o=Object.values(s).reduce((p,d)=>p+d.subtotal,0),n=Object.values(s).reduce((p,d)=>p+d.discount,0),r=Object.values(s).reduce((p,d)=>p+d.taxable,0);let g=0;xe==="percentage"?g=r*(parseFloat(be)||0)/100:g=parseFloat(be)||0,g>r&&(g=r);const A=r>0?(r-g)/r:0,_=Object.keys(s).reduce((p,d)=>{const Y=s[d],ce=Y.taxable*A,I=Y.gst*A;return p[d]={...Y,taxable:ce,gst:I,total:ce+I},p},{}),P=Object.values(_).reduce((p,d)=>p+d.gst,0),it=Object.values(_).reduce((p,d)=>p+d.taxable,0)+P;return{subtotal:o,itemDiscountAmount:n,globalDiscountAmount:g,discountAmount:n+g,gstAmount:P,total:it,moduleSummary:_,computedItems:a}},[JSON.stringify(b||[]),be,xe,O,B,F,G,$,k,L]),qe=gt(),Pe=_e({mutationFn:t=>U.createBill(t),onSuccess:t=>{w.success("Bill created successfully"),qe.invalidateQueries(["bills"]),J("/billing")},onError:t=>{var s,a;w.error(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to create bill")}}),{data:re}=D({queryKey:["bill",T],queryFn:()=>T?U.getBill(T):Promise.resolve(null),enabled:!!T});x.useEffect(()=>{if(re&&T){const t=re.data||re;if(X(t.patient||null),t.doctor&&ae({id:t.doctor.id,name:t.doctor.name}),t.type){const a=(t.type||"").toString().toUpperCase();K(a==="PHARMACY"?"pharmacy":a==="LAB_TEST"?"lab":"consultation")}const s=(t.items||[]).map(a=>({productId:a.productId||null,labId:a.labId||null,labTestId:a.labTestId||null,description:a.description||"",quantity:a.quantity||1,unitPrice:a.unitPrice||a.amount||0,type:S(a),gstPercent:a.gstPercent??"",discountPercent:a.discountPercent??"",discountAmount:a.discountAmount??"",doctorId:a.doctorId||void 0}));try{c("items",s),t.discountPercent!==null&&t.discountPercent!==void 0?(c("discount",t.discountPercent||0),c("discountType","percentage")):(c("discount",t.discountAmount||0),c("discountType","fixed"));const a=Number(t.subtotal||0),o=Number(t.discountAmount||0),n=a-o;if(n>0){const r=Number(t.taxAmount||0)/n*100||0;c("gstRate",Math.round(r*100)/100)}else c("gstRate",0);c("notes",t.notes||""),c("defaultConsultationGstPercent",t.defaultConsultationGstPercent??5),c("defaultPharmacyGstPercent",t.defaultPharmacyGstPercent??10),c("defaultLabTestGstPercent",t.defaultLabTestGstPercent??20),c("defaultConsultationDiscountPercent",t.defaultConsultationDiscountPercent??0),c("defaultPharmacyDiscountPercent",t.defaultPharmacyDiscountPercent??0),c("defaultLabTestDiscountPercent",t.defaultLabTestDiscountPercent??0)}catch{}}},[re,T]);const et=_e({mutationFn:({id:t,data:s})=>U.updateBill(t,s),onSuccess:()=>{w.success("Bill updated successfully"),qe.invalidateQueries(["bills"]),J("/billing")},onError:t=>{var s,a;w.error(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to update bill")}}),tt=async t=>{var s;X(t),oe(t.name),W(!1);try{const a=await U.getPrefill(t.id),o=a==null?void 0:a.data;if(o!=null&&o.hasPrefill&&Array.isArray(o.items)&&o.items.length>0){const n=o.items.map(r=>({...r,type:S(r)}));n.forEach((r,g)=>{const A=Re(r);(r.gstPercent===""||r.gstPercent==null)&&(r.gstPercent=A.gstPercent),(r.discountPercent===""||r.discountPercent==null)&&(r.discountAmount===""||r.discountAmount==null)&&(r.discountPercent=A.discountPercent),n[g]=r}),We(n),c("items",n),(s=o.doctor)!=null&&s.id&&ae({id:o.doctor.id,name:o.doctor.name}),w.success("Medicine and lab test amounts prefilled from latest prescription")}}catch(a){console.error("Failed to prefill bill from prescription:",a)}},st=t=>{ae(t||null),X(null),oe("")};x.useEffect(()=>{if(!v&&C&&l){const t=ne.find(s=>s.id===l.id)||{id:l.id,name:l.name};ae(t)}},[l,C,v]);const at=t=>{const s=b.findIndex(a=>a.productId===t.id);if(s>=0){const a=(parseInt(b[s].quantity)||0)+1;c(`items.${s}.quantity`,a),w.success(`${t.name} quantity updated`)}else me({productId:t.id,description:t.name,quantity:1,unitPrice:t.sellingPrice||t.mrp||0,type:"pharmacy",gstPercent:F,discountPercent:k}),w.success(`${t.name} added to bill`);Ae(""),ee(!1)},nt=t=>{Ke(t),ie(t.name)},lt=t=>{me({productId:null,description:t.name,quantity:1,unitPrice:t.price||0,type:"lab_test",labId:(y==null?void 0:y.id)||t.labId||null,labTestId:t.id||null,gstPercent:G,discountPercent:L}),w.success(`${t.name} added to bill`),Ie(""),de(!1)},rt=()=>{const t=(i==null?void 0:i.id)||(C&&!v?l==null?void 0:l.id:void 0);me({productId:null,description:"",quantity:1,unitPrice:u==="consultation"?ve(t):0,type:u==="consultation"?"consultation":u==="lab"?"lab_test":u==="pharmacy"?"pharmacy":"other",doctorId:u==="consultation"?(i==null?void 0:i.id)||(C&&!v?l==null?void 0:l.id:void 0):void 0,gstPercent:u==="consultation"?B:u==="lab"?G:u==="pharmacy"?F:O,discountPercent:u==="consultation"?$:u==="lab"?L:u==="pharmacy"?k:0})};x.useEffect(()=>{(b||[]).forEach((t,s)=>{const a=Re(t),o=(t==null?void 0:t.gstPercent)===""||(t==null?void 0:t.gstPercent)==null,n=(t==null?void 0:t.discountPercent)===""||(t==null?void 0:t.discountPercent)==null,r=(t==null?void 0:t.discountAmount)===""||(t==null?void 0:t.discountAmount)==null;o&&c(`items.${s}.gstPercent`,a.gstPercent),n&&r&&c(`items.${s}.discountPercent`,a.discountPercent)})},[b,B,F,G,$,k,L,O,c]),x.useEffect(()=>{if(u!=="consultation")return;const t=(i==null?void 0:i.id)||(C&&!v?l==null?void 0:l.id:void 0);if(!t)return;const s=ve(t);s<=0||(b||[]).forEach((a,o)=>{((a==null?void 0:a.type)||"").toLowerCase()==="consultation"&&(a!=null&&a.doctorId||c(`items.${o}.doctorId`,t),(!(a!=null&&a.unitPrice)||Number(a.unitPrice)<=0)&&c(`items.${o}.unitPrice`,s))})},[u,i==null?void 0:i.id,le,C,v,l==null?void 0:l.id,b,c]);const ct=t=>{if(!N){w.error("Please select a patient");return}if(t.items.length===0){w.error("Please add at least one item");return}const s={pharmacy:"PHARMACY",consultation:"CONSULTATION",lab:"LAB_TEST"},a=String(t.discountType||"fixed").toLowerCase()==="percentage"?"PERCENTAGE":"AMOUNT",o={patientId:N.id,doctorId:i==null?void 0:i.id,type:s[u]||"MIXED",items:t.items.map(n=>({description:n.description,quantity:parseInt(n.quantity),unitPrice:parseFloat(n.unitPrice),type:S(n),gstPercent:n.gstPercent!==""&&n.gstPercent!=null?parseFloat(n.gstPercent):null,discountPercent:n.discountPercent!==""&&n.discountPercent!=null?parseFloat(n.discountPercent):null,discountAmount:n.discountAmount!==""&&n.discountAmount!=null?parseFloat(n.discountAmount):null,productId:n.productId||void 0,labId:n.labId||void 0,labTestId:n.labTestId||void 0,doctorId:n.doctorId||void 0})),discount:parseFloat(t.discount)||0,discountType:a,taxConfig:{gstRate:parseFloat(t.gstRate)||0},notes:t.notes,defaultConsultationGstPercent:parseFloat(t.defaultConsultationGstPercent)||0,defaultPharmacyGstPercent:parseFloat(t.defaultPharmacyGstPercent)||0,defaultLabTestGstPercent:parseFloat(t.defaultLabTestGstPercent)||0,defaultConsultationDiscountPercent:parseFloat(t.defaultConsultationDiscountPercent)||0,defaultPharmacyDiscountPercent:parseFloat(t.defaultPharmacyDiscountPercent)||0,defaultLabTestDiscountPercent:parseFloat(t.defaultLabTestDiscountPercent)||0};ue&&parseFloat(t.paymentAmount)>0&&(o.payment={amount:parseFloat(t.paymentAmount),method:t.paymentMethod,reference:t.paymentReference}),T?et.mutate({id:T,data:o}):Pe.mutate(o)},h=t=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:0}).format(t||0),ot=t=>{const s=S(t),a=Math.max(0,Number((t==null?void 0:t.quantity)||0)),o=Math.max(0,Number((t==null?void 0:t.unitPrice)||0)),n=a*o;let r=Number(t==null?void 0:t.discountAmount);if(!Number.isFinite(r)||r<0){let P=Number(t==null?void 0:t.discountPercent);(!Number.isFinite(P)||P<0)&&(s==="consultation"?P=$:s==="pharmacy"?P=k:s==="lab_test"?P=L:P=0),r=n*P/100}r>n&&(r=n);let g=Number(t==null?void 0:t.gstPercent);(!Number.isFinite(g)||g<0)&&(s==="consultation"?g=B:s==="pharmacy"?g=F:s==="lab_test"?g=G:g=O);const A=Math.max(0,n-r),_=A*g/100;return{subtotal:n,discountAmount:r,taxable:A,gstAmount:_,total:A+_}};return e.jsxs("div",{className:"min-h-screen bg-gray-50 p-6",children:[e.jsxs("div",{className:"max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>J("/billing"),className:"p-2 hover:bg-gray-100 rounded-lg transition",children:e.jsx(ht,{className:"text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"New Bill"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Create a new invoice"})]})]}),e.jsx("form",{onSubmit:Je(ct),children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[Ve(),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(ft,{className:"text-blue-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Patient"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"w-1/3",children:[e.jsxs("select",{value:(i==null?void 0:i.id)||"",onChange:t=>{const s=t.target.value,a=ne.find(o=>o.id===s)||null;st(a)},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[v&&e.jsx("option",{value:"",children:"All Doctors"}),ne.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),!v&&e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Listing patients for all doctors is restricted to clinic admins and accountants."})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",value:V,onChange:t=>{oe(t.target.value),W(!0),t.target.value||X(null)},onFocus:()=>W(!0),placeholder:"Search patient by name or phone...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"})]})]}),Se&&Fe.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto",children:Fe.map(t=>e.jsxs("button",{type:"button",onClick:()=>tt(t),className:"w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-0",children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.phone," ",t.email&&`â€¢ ${t.email}`]})]},t.id))})]}),N&&e.jsxs("div",{className:"mt-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("p",{className:"font-medium text-blue-900",children:N.name}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:[N.phone,N.email&&` â€¢ ${N.email}`]}),N.patientId&&e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["ID: ",N.patientId]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Bill Type"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:wt.map(t=>e.jsx("button",{type:"button",onClick:()=>K(t.id),className:`px-4 py-2 rounded-lg font-medium transition ${u===t.id?t.color==="blue"?"bg-blue-600 text-white":t.color==="green"?"bg-green-600 text-white":"bg-purple-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:t.label},t.id))})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"text-blue-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Items"})]}),e.jsxs("button",{type:"button",onClick:rt,className:"inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700",children:[e.jsx(yt,{}),"Add Item"]})]}),u==="pharmacy"&&e.jsxs("div",{className:"relative mb-4",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",value:Z,onChange:t=>{Ae(t.target.value),ee(!0)},onFocus:()=>ee(!0),placeholder:"Search and add products...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"}),Ce&&Ge.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto",children:Ge.map(t=>e.jsxs("button",{type:"button",onClick:()=>at(t),className:"w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-0 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Stock: ",t.quantity," ",t.unit||"units"]})]}),e.jsx("span",{className:"font-medium text-gray-900",children:h(t.sellingPrice||t.mrp)})]},t.id))})]}),u==="lab"&&e.jsxs("div",{className:"mb-4 bg-white rounded p-4 border border-gray-100",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Lab"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:M,onChange:t=>{ie(t.target.value)},onFocus:()=>ie(M),placeholder:"Search labs...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),M&&ke.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-auto",children:ke.map(t=>{var s;return e.jsx("button",{type:"button",onClick:()=>nt(t),className:"w-full text-left px-4 py-2 hover:bg-gray-50 border-b border-gray-100",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),t.contactPerson&&e.jsx("p",{className:"text-xs text-gray-500",children:t.contactPerson})]}),e.jsx("div",{className:"text-sm text-gray-500",children:((s=t._count)==null?void 0:s.bills)||""})]})},t.id)})})]})]}),y&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-700 mb-2",children:["Selected Lab: ",e.jsx("strong",{children:y.name})]}),e.jsxs("div",{className:"relative mb-2",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",value:H,onChange:t=>{Ie(t.target.value),de(!0)},onFocus:()=>de(!0),placeholder:"Search lab tests...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),He&&H.length>=1&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:Le.length===0?e.jsx("div",{className:"px-4 py-3 text-sm text-gray-500",children:"No lab tests found"}):Le.map(t=>e.jsx("button",{type:"button",onClick:()=>lt(t),className:"w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-0",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.name}),t.category&&e.jsx("p",{className:"text-sm text-gray-500",children:t.category})]}),e.jsxs("div",{className:"text-sm font-medium text-gray-800",children:[t.price," ",t.currency||"INR"]})]})},t.id))})]})]})]}),te.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Oe,{className:"text-3xl mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No items added yet"}),e.jsx("p",{className:"text-sm mt-1",children:u==="pharmacy"?"Search and add products above":'Click "Add Item" to add items'})]}):e.jsx("div",{className:"space-y-4",children:te.map((t,s)=>e.jsxs("div",{className:`rounded-xl border shadow-sm overflow-hidden ${s%2===0?"bg-white border-gray-200":"bg-slate-50/70 border-slate-300"}`,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200/80 bg-white/70",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-md text-[11px] font-semibold bg-gray-100 text-gray-700",children:["Item ",s+1]}),e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-md text-[11px] font-semibold bg-blue-50 border border-blue-100 text-blue-700 uppercase",children:S((b==null?void 0:b[s])||t).replace("_"," ")})]}),e.jsx("button",{type:"button",onClick:()=>Xe(s),className:"p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition",title:"Remove item",children:e.jsx(jt,{})})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-3",children:[e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-gray-500 mb-2",children:"Line 1: Item Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-3 items-end",children:[e.jsxs("div",{className:S((b==null?void 0:b[s])||t)==="consultation"?"md:col-span-6":"md:col-span-9",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Description"}),e.jsx("input",{...m(`items.${s}.description`,{required:!0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"Item description"})]}),S((b==null?void 0:b[s])||t)==="consultation"&&e.jsxs("div",{className:"md:col-span-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Doctor"}),e.jsxs("select",{...m(`items.${s}.doctorId`,{onChange:a=>{var r;const o=(r=a==null?void 0:a.target)==null?void 0:r.value;if(!o)return;const n=ve(o);c(`items.${s}.unitPrice`,Number.isFinite(n)?n:0)}}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",children:[!v&&e.jsx("option",{value:l==null?void 0:l.id,children:l==null?void 0:l.name}),v&&e.jsx("option",{value:"",children:"Select doctor"}),ne.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Qty"}),e.jsx("input",{type:"number",min:"1",...m(`items.${s}.quantity`,{required:!0,min:1}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Price (INR)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",...m(`items.${s}.unitPrice`,{required:!0,min:0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]})]}),e.jsxs("div",{className:"rounded-lg border border-blue-100 bg-blue-50/40 p-3",children:[e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-blue-700 mb-2",children:"Line 2: GST & Discount"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"GST (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m(`items.${s}.gstPercent`),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Discount (%)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",...m(`items.${s}.discountPercent`),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Discount Amount"}),e.jsx("input",{type:"number",step:"0.01",min:"0",...m(`items.${s}.discountAmount`),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})]})]})]})]}),e.jsx("div",{className:"mt-3 text-xs text-gray-500 border-t border-gray-100 pt-2",children:(()=>{const a=ot((b==null?void 0:b[s])||t);return`Line Total ${h(a.total)} | Taxable ${h(a.taxable)} | GST ${h(a.gstAmount)}`})()})]},t.id))})]}),e.jsxs("div",{className:"rounded-xl border border-gray-200 shadow-sm overflow-hidden bg-white",children:[e.jsx("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200/80 bg-white/70",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded-md text-[11px] font-semibold bg-gray-100 text-gray-700",children:"Billing Rules"}),e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-semibold bg-blue-50 border border-blue-100 text-blue-700 uppercase",children:[e.jsx(Nt,{className:"text-[10px]"}),"Bill-Level Discount"]})]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-3",children:[e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-gray-500 mb-2",children:"Discount Controls"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-3 items-end",children:[e.jsxs("div",{className:"md:col-span-6",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Discount Type"}),e.jsxs("select",{...m("discountType"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",children:[e.jsx("option",{value:"fixed",children:"Fixed Amount (INR)"}),e.jsx("option",{value:"percentage",children:"Percentage (%)"})]})]}),e.jsxs("div",{className:"md:col-span-6",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:["Discount ",xe==="percentage"?"(%)":"(INR)"]}),e.jsx("input",{type:"number",step:"0.01",min:"0",...m("discount"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",placeholder:"0"})]})]})]}),e.jsxs("div",{className:"rounded-lg border border-blue-100 bg-blue-50/40 p-3",children:[e.jsx("div",{className:"text-[11px] font-semibold uppercase tracking-wide text-blue-700 mb-2",children:"Tax Fallback"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-3 items-end",children:e.jsxs("div",{className:"md:col-span-6",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-500 mb-1",children:"Fallback GST For Other Items"}),e.jsx("select",{...m("gstRate"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm",children:Tt.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]})})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notes (Optional)"}),e.jsx("textarea",{...m("notes"),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",placeholder:"Any additional notes for this bill..."})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 sticky top-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Bill Summary"}),e.jsxs("div",{className:"space-y-3",children:[Object.values(f.moduleSummary||{}).filter(t=>t.subtotal>0).map(t=>e.jsxs("div",{className:"rounded-lg border border-gray-100 p-3 bg-gray-50/60",children:[e.jsxs("div",{className:"flex justify-between text-sm font-medium text-gray-800",children:[e.jsx("span",{children:t.label}),e.jsx("span",{children:h(t.total)})]}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:h(t.subtotal)})]}),t.discount>0&&e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"Item Discount"}),e.jsxs("span",{children:["-",h(t.discount)]})]}),t.gst>0&&e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"GST"}),e.jsxs("span",{children:["+",h(t.gst)]})]})]},t.label)),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Subtotal"}),e.jsx("span",{className:"text-gray-900",children:h(f.subtotal)})]}),f.itemDiscountAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Item Discounts"}),e.jsxs("span",{className:"text-red-600",children:["-",h(f.itemDiscountAmount)]})]}),f.globalDiscountAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Bill Discount"}),e.jsxs("span",{className:"text-red-600",children:["-",h(f.globalDiscountAmount)]})]}),f.gstAmount>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"GST"}),e.jsxs("span",{className:"text-gray-900",children:["+",h(f.gstAmount)]})]}),e.jsx("div",{className:"border-t border-gray-100 pt-3",children:e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{className:"text-gray-900",children:"Total"}),e.jsx("span",{className:"text-blue-600",children:h(f.total)})]})})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-gray-100",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ue,onChange:t=>Qe(t.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Collect Payment Now"})]}),ue&&e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method"}),e.jsx("select",{...m("paymentMethod"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:St.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (â‚¹)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:f.total,...m("paymentAmount"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:f.total.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference / Transaction ID"}),e.jsx("input",{...m("paymentReference"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Optional"})]}),pe>0&&pe<f.total&&e.jsxs("p",{className:"text-sm text-yellow-600 bg-yellow-50 p-2 rounded",children:["Balance due after payment:"," ",e.jsx("span",{className:"font-medium",children:h(f.total-pe)})]})]})]}),e.jsxs("div",{className:"mt-6 space-y-3",children:[e.jsxs("button",{type:"submit",disabled:Pe.isPending||!N||te.length===0,className:"w-full inline-flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(vt,{}),Pe.isPending?"Creating...":"Create Bill"]}),e.jsx("button",{type:"button",onClick:()=>J("/billing"),className:"w-full px-4 py-2.5 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"})]})]})})]})})]}),(Se||Ce)&&e.jsx("div",{className:"fixed inset-0 z-0",onClick:()=>{W(!1),ee(!1)}})]})}export{kt as default};
