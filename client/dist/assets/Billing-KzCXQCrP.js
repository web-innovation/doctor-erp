import{u as be,I as ve,r as o,b as we,J as H,p as D,j as e,L as Pe,y as Ce,K as Se,M as Te,N as Ae,v as Fe,d as De,a5 as K,ak as W,O as Ie,P as ke,Q as J,z as h,D as X}from"./index-ae8E7MVz.js";import{u as Y}from"./useMutation-BTnhOH6c.js";import{b as I}from"./billingService-B6DSiyVo.js";import{a as Be}from"./printTemplates-BhPuBDug.js";const Z={pending:"bg-yellow-100 text-yellow-800",partial:"bg-blue-100 text-blue-800",paid:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"},Oe=[{value:"",label:"All Status"},{value:"pending",label:"Pending"},{value:"partial",label:"Partial"},{value:"paid",label:"Paid"},{value:"cancelled",label:"Cancelled"}],ee=[0,5,10,12,18,20,30];function qe(){var z,Q,L,_,V,$;const te=be(),w=ve(),[y,se]=o.useState(""),[m,g]=o.useState(1),[P,ae]=o.useState(!1),[i,k]=o.useState({status:"",startDate:"",endDate:""}),[ne,j]=o.useState(!1),[s,p]=o.useState(null),[re,N]=o.useState(!1),[le,B]=o.useState(null),[ie,de]=o.useState({}),f=10,{register:b,handleSubmit:ce,reset:C,formState:{errors:v}}=we(),oe=H("billing:create",["SUPER_ADMIN","DOCTOR","ACCOUNTANT","PHARMACIST","RECEPTIONIST"]),O=H("billing:edit",["SUPER_ADMIN","DOCTOR","ACCOUNTANT","PHARMACIST","RECEPTIONIST"]),{data:d,isLoading:xe}=D({queryKey:["bills",m,f,y,i],queryFn:()=>I.getBills({page:m,limit:f,search:y,...i}),placeholderData:t=>t}),{data:me}=D({queryKey:["clinic-settings"],queryFn:()=>X.getClinicSettings()}),{data:ue}=D({queryKey:["print-templates"],queryFn:()=>X.getPrintTemplates()}),R=(d==null?void 0:d.data)||[],S=((z=d==null?void 0:d.pagination)==null?void 0:z.totalPages)||1,M=((Q=d==null?void 0:d.pagination)==null?void 0:Q.total)||0,T=Y({mutationFn:({id:t,paymentData:a})=>I.recordPayment(t,a),onSuccess:()=>{h.success("Payment recorded successfully"),w.invalidateQueries(["bills"]),j(!1),p(null),C()},onError:t=>{var a,n;h.error(((n=(a=t.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to record payment")}}),pe=Y({mutationFn:({id:t,payload:a})=>I.updateBill(t,a),onSuccess:()=>{h.success("GST updated"),w.invalidateQueries(["bills"]),s!=null&&s.id&&w.invalidateQueries(["bill",s.id])},onError:t=>{var a,n;h.error(((n=(a=t.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to update GST")},onSettled:()=>B(null)}),ge=t=>{se(t.target.value),g(1)},A=(t,a)=>{k(n=>({...n,[t]:a})),g(1)},he=()=>{k({status:"",startDate:"",endDate:""}),g(1)},E=t=>{p(t),j(!0)},ye=t=>{p(t),N(!0)},G=t=>{const a=window.open("","_blank");if(!a){h.error("Please allow popups to print");return}const n=Be(t,me||{},ue||{});a.document.write(n),a.document.close(),a.onload=()=>a.print()},je=t=>{s&&T.mutate({id:s.id,paymentData:{amount:parseFloat(t.amount),method:t.method,reference:t.reference,notes:t.notes}})},q=t=>t?new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",l=t=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:0}).format(t||0),x=t=>t.dueAmount||0,F=t=>{const a=Number((t==null?void 0:t.subtotal)||0)-Number((t==null?void 0:t.discountAmount)||0),n=Number((t==null?void 0:t.taxAmount)||0);if(a<=0||n<=0)return 0;const c=Math.round(n/a*100*100)/100,u=ee.find(r=>Number(r)===Number(c));return u!==void 0?u:0},Ne=(t,a)=>{const n=Number(a||0),c=Number((t==null?void 0:t.discountPercent)||0)>0,u={notes:(t==null?void 0:t.notes)||"",doctorId:(t==null?void 0:t.doctorId)||void 0,type:(t==null?void 0:t.type)||void 0,discountType:c?"PERCENTAGE":"AMOUNT",discount:Number(c?(t==null?void 0:t.discountPercent)||0:(t==null?void 0:t.discountAmount)||0),taxConfig:{gstRate:n},items:((t==null?void 0:t.items)||[]).map(r=>({description:r.description,quantity:Number(r.quantity)||1,unitPrice:Number(r.unitPrice)||0,gstPercent:Number(r.gstPercent)||0,productId:r.productId||null,labId:r.labId||null,labTestId:r.labTestId||null,doctorId:r.doctorId||null}))};B(t.id),pe.mutate({id:t.id,payload:u})},fe=(t,a)=>{const n=Number(a||0);de(c=>({...c,[t.id]:n})),Ne(t,n)},U=i.status||i.startDate||i.endDate;return e.jsxs("div",{className:"min-h-screen bg-gray-50 p-6",children:[e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Billing"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Manage invoices and payments"})]}),oe&&e.jsxs(Pe,{to:"/billing/new",className:"inline-flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition",children:[e.jsx(Ce,{}),"New Bill"]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Se,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",value:y,onChange:ge,placeholder:"Search by bill number or patient name...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"})]}),e.jsx("select",{value:i.status,onChange:t=>A("status",t.target.value),className:"px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:Oe.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsxs("button",{onClick:()=>ae(!P),className:`inline-flex items-center gap-2 px-4 py-2.5 border rounded-lg font-medium transition ${P||U?"border-blue-500 text-blue-600 bg-blue-50":"border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(Te,{}),"Date Filter",(i.startDate||i.endDate)&&e.jsx("span",{className:"bg-blue-600 text-white text-xs px-1.5 py-0.5 rounded-full",children:"1"})]})]}),P&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"From Date"}),e.jsx("input",{type:"date",lang:"en-GB",value:i.startDate,onChange:t=>A("startDate",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"To Date"}),e.jsx("input",{type:"date",lang:"en-GB",value:i.endDate,onChange:t=>A("endDate",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{onClick:he,className:"flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-800 transition",children:[e.jsx(Ae,{}),"Clear Filters"]})})]})})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:xe?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):R.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500",children:[e.jsx(Fe,{className:"text-4xl mb-4"}),e.jsx("p",{className:"font-medium",children:"No bills found"}),e.jsx("p",{className:"text-sm mt-1",children:y||U?"Try adjusting your search or filters":"Create your first bill to get started"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Bill No"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Patient"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Apply Fix GST"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:R.map(t=>{var a,n,c,u;return e.jsxs("tr",{className:"hover:bg-gray-50 transition",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-blue-600",children:t.billNo||t.id.slice(-8).toUpperCase()})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-600",children:q(t.createdAt)})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((a=t.patient)==null?void 0:a.name)||"Unknown Patient"}),((n=t.patient)==null?void 0:n.phone)&&e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:t.patient.phone})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:l(t.totalAmount)}),t.status!=="paid"&&x(t)>0&&e.jsxs("p",{className:"text-xs text-red-600 mt-0.5",children:["Due: ",l(x(t))]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:O?e.jsx("select",{value:Number(ie[t.id]??0),onChange:r=>fe(t,r.target.value),disabled:le===t.id,className:"px-2 py-1.5 text-sm border border-gray-300 rounded-lg bg-white disabled:opacity-60",children:ee.map(r=>e.jsx("option",{value:r,children:r===0?"Apply Fix GST (0%)":`${r}%`},r))}):e.jsxs("span",{className:"text-sm text-gray-600",children:[F(t),"%"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-2.5 py-1 rounded-full text-xs font-medium capitalize ${Z[(c=t.paymentStatus)==null?void 0:c.toLowerCase()]||Z.pending}`,children:((u=t.paymentStatus)==null?void 0:u.toLowerCase())||"pending"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>ye(t),className:"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition",title:"View",children:e.jsx(De,{})}),e.jsx("button",{onClick:()=>G(t),className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition",title:"Print",children:e.jsx(K,{})}),t.status!=="paid"&&t.status!=="cancelled"&&e.jsxs("button",{onClick:()=>E(t),className:"inline-flex items-center gap-1 px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-sm font-medium hover:bg-green-100 transition",title:"Record Payment",children:[e.jsx(W,{className:"text-xs"}),"Pay"]})]})})]},t.id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Showing"," ",e.jsx("span",{className:"font-medium",children:(m-1)*f+1})," ","to"," ",e.jsx("span",{className:"font-medium",children:Math.min(m*f,M)})," ","of ",e.jsx("span",{className:"font-medium",children:M})," bills"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>g(t=>Math.max(1,t-1)),disabled:m===1,className:"p-2 rounded-lg border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition",children:e.jsx(Ie,{className:"text-gray-600"})}),e.jsxs("span",{className:"text-sm text-gray-600",children:["Page ",m," of ",S]}),e.jsx("button",{onClick:()=>g(t=>Math.min(S,t+1)),disabled:m===S,className:"p-2 rounded-lg border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition",children:e.jsx(ke,{className:"text-gray-600"})})]})]})]})})]}),e.jsx(J,{isOpen:ne,onClose:()=>{j(!1),p(null),C()},title:"Record Payment",size:"md",children:s&&e.jsxs("form",{onSubmit:ce(je),className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Bill Number"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.billNo||s.id.slice(-8).toUpperCase()})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Balance Due"}),e.jsx("p",{className:"font-medium text-red-600",children:l(x(s))})]})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Amount (â‚¹) ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",...b("amount",{required:"Amount is required",min:{value:1,message:"Amount must be at least 1"},max:{value:x(s),message:`Amount cannot exceed ${l(x(s))}`}}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter amount",defaultValue:x(s)}),v.amount&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.amount.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Method ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...b("method",{required:"Payment method is required"}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select method"}),e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"netbanking",children:"Net Banking"}),e.jsx("option",{value:"insurance",children:"Insurance"}),e.jsx("option",{value:"other",children:"Other"})]}),v.method&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.method.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference / Transaction ID"}),e.jsx("input",{...b("reference"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter reference number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{...b("notes"),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",placeholder:"Optional payment notes"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100",children:[e.jsx("button",{type:"button",onClick:()=>{j(!1),p(null),C()},className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:T.isPending,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50",children:T.isPending?"Recording...":"Record Payment"})]})]})}),e.jsx(J,{isOpen:re,onClose:()=>{N(!1),p(null)},title:"Bill Details",size:"lg",children:s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-start pb-4 border-b border-gray-100",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Bill Number"}),e.jsx("p",{className:"font-bold text-lg text-gray-900",children:s.billNo||s.id.slice(-8).toUpperCase()})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Date"}),e.jsx("p",{className:"font-medium text-gray-900",children:q(s.createdAt)})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"Patient"}),e.jsx("p",{className:"font-medium text-gray-900",children:((L=s.patient)==null?void 0:L.name)||"Unknown Patient"}),((_=s.patient)==null?void 0:_.phone)&&e.jsx("p",{className:"text-sm text-gray-600",children:s.patient.phone}),((V=s.doctor)==null?void 0:V.name)&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Doctor: Dr. ",s.doctor.name]})]}),s.items&&s.items.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Items"}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-gray-600",children:"Description"}),e.jsx("th",{className:"px-4 py-2 text-center text-gray-600",children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-right text-gray-600",children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-right text-gray-600",children:"Total"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:s.items.map((t,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-gray-900",children:t.description}),e.jsx("td",{className:"px-4 py-2 text-center text-gray-600",children:t.quantity}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-600",children:l(t.unitPrice)}),e.jsx("td",{className:"px-4 py-2 text-right font-medium text-gray-900",children:l(t.quantity*t.unitPrice)})]},a))})]})})]}),e.jsxs("div",{className:"border-t border-gray-100 pt-4 space-y-2",children:[s.discount>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Discount"}),e.jsxs("span",{className:"text-red-600",children:["-",l(s.discount)]})]}),F(s)>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-500",children:["Tax (",F(s),"%)"]}),e.jsx("span",{className:"text-gray-600",children:l(s.taxAmount||0)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{className:"text-gray-900",children:"Total Amount"}),e.jsx("span",{className:"text-gray-900",children:l(s.totalAmount)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Paid"}),e.jsx("span",{className:"text-green-600",children:l((($=s.payments)==null?void 0:$.reduce((t,a)=>t+a.amount,0))||0)})]}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"Balance Due"}),e.jsx("span",{className:x(s)>0?"text-red-600":"text-green-600",children:l(x(s))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100",children:[e.jsxs("button",{onClick:()=>G(s),className:"inline-flex items-center gap-2 px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:[e.jsx(K,{}),"Print"]}),O&&e.jsx("button",{onClick:()=>{N(!1),te(`/billing/${s.id}/edit`)},className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:"Edit"}),s.status!=="paid"&&s.status!=="cancelled"&&e.jsxs("button",{onClick:()=>{N(!1),E(s)},className:"inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition",children:[e.jsx(W,{}),"Record Payment"]})]})]})})]})}export{qe as default};
