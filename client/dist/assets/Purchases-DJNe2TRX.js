import{J as R,p as te,r as m,j as e,z as b}from"./index-CMIIMqsb.js";import{p as j}from"./purchaseService-CVRzN7oS.js";import{p as G}from"./pharmacyService-DmVPBq5p.js";function ae(i){if(!(i!=null&&i.parsedJson))return null;try{return typeof i.parsedJson=="string"?JSON.parse(i.parsedJson):i.parsedJson}catch{return null}}function K(i){var x,v;if(!i)return i;const u=ae(i.upload);if(!u)return i;const N=Array.isArray(u.items)?u.items:[],P=Number((u==null?void 0:u.roundOff)??(u==null?void 0:u.round_off)??((x=u==null?void 0:u.totals)==null?void 0:x.roundOff)??((v=u==null?void 0:u.totals)==null?void 0:v.round_off)??(i==null?void 0:i.roundOff)??(i==null?void 0:i.roundoff)??0),g=Array.isArray(i.items)?i.items.map((f,k)=>{var r,h;return{...f,mrp:Number((f==null?void 0:f.mrp)??((r=N[k])==null?void 0:r.mrp)??((h=N[k])==null?void 0:h.MRP)??0)}}):[];return{...i,roundOff:P,roundoff:P,items:g}}function W(i){if(!i)return"";const u=i.path||"";return u&&(/^https?:\/\//i.test(u)||u.startsWith("/"))?u:i.filename?`/uploads/purchases/${i.filename}`:""}function se(){const i=R("purchases:read"),u=R("purchases:delete"),{data:N,isLoading:P,refetch:g}=te({queryKey:["purchases","DRAFT"],queryFn:()=>j.getPurchases({status:"DRAFT",limit:50}),enabled:!!i}),x=(N==null?void 0:N.data)||N||{},v=Array.isArray(x==null?void 0:x.data)?x.data:Array.isArray(x)?x:[],[f,k]=m.useState({}),[r,h]=m.useState(null),[w,C]=m.useState(""),[$,A]=m.useState([]),[_,Q]=m.useState(!1),[B,E]=m.useState(null),[S,p]=m.useState([]),[q,D]=m.useState({}),[H,T]=m.useState({}),[V,M]=m.useState({}),I=m.useRef({}),X=R("purchases:receive");m.useEffect(()=>{if(!w||w.length<2){A([]);return}Q(!0);const t=setTimeout(async()=>{try{const a=await j.getSuppliers(w),s=(a==null?void 0:a.data)||a;A(Array.isArray(s)?s:[])}catch{A([])}finally{Q(!1)}},300);return()=>clearTimeout(t)},[w]),m.useEffect(()=>{if(!r)return;const t=Array.isArray(r.items)?r.items.map(a=>({id:a.id,productId:a.productId,name:a.name,quantity:Number(a.quantity||0),unitPrice:Number(a.unitPrice||a.purchasePrice||0),mrp:Number(a.mrp||0),taxAmount:Number(a.taxAmount||0),amount:Number(a.amount||0),batchNumber:a.batchNumber||null,expiryDate:a.expiryDate?new Date(a.expiryDate).toISOString().slice(0,10):"",newEntry:!1})):[];p(t)},[r&&r.id]),m.useEffect(()=>{if(!r)return;const t=S.reduce((c,n)=>c+Number(n.amount||Number(n.quantity||0)*Number(n.unitPrice||0)),0),a=Number(r.taxAmount||0),s=Number((r.roundOff??r.roundoff)||0),l=+(t+a-s).toFixed(2);h(c=>({...c,subtotal:+(t.toFixed?t.toFixed(2):t),totalAmount:l,roundOff:s}))},[S,r==null?void 0:r.taxAmount,r==null?void 0:r.roundOff,r==null?void 0:r.roundoff]),m.useEffect(()=>()=>{try{Object.values(I.current||{}).forEach(t=>clearTimeout(t))}catch{}},[]);const Y=(t,a)=>{if(M(s=>({...s,[t]:a})),I.current[t]&&clearTimeout(I.current[t]),!a||a.length<2){D(s=>({...s,[t]:[]})),T(s=>({...s,[t]:!1}));return}T(s=>({...s,[t]:!0})),I.current[t]=setTimeout(async()=>{try{const s=await G.getProducts({search:a,limit:10}),l=s.data||s;D(c=>({...c,[t]:Array.isArray(l)?l:[]}))}catch{D(l=>({...l,[t]:[]}))}finally{T(s=>({...s,[t]:!1}))}},300)};return e.jsx(e.Fragment,{children:e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Purchases — Drafts"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Draft purchases created from uploads"})]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-auto",children:P?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Loading…"}):v.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"No draft purchases found"}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-left",children:"Invoice No"}),e.jsx("th",{className:"p-3 text-left",children:"Supplier"}),e.jsx("th",{className:"p-3 text-left",children:"Date"}),e.jsx("th",{className:"p-3 text-right",children:"Total"}),e.jsx("th",{className:"p-3 text-left",children:"Status"})]})}),e.jsx("tbody",{children:v.map(t=>{var a,s;return e.jsxs("tr",{className:"border-t hover:bg-gray-50",children:[e.jsx("td",{className:"p-3",children:t.invoiceNo}),e.jsx("td",{className:"p-3",children:((a=t.supplier)==null?void 0:a.name)||(f[t.supplierId]?f[t.supplierId].name:t.supplierId?"Assigned":"—")}),e.jsx("td",{className:"p-3",children:t.invoiceDate?new Date(t.invoiceDate).toLocaleDateString("en-GB"):"-"}),e.jsx("td",{className:"p-3 text-right",children:(s=t.totalAmount)!=null&&s.toFixed?t.totalAmount.toFixed(2):t.totalAmount}),e.jsx("td",{className:"p-3",children:t.status}),e.jsxs("td",{className:"p-3 text-right flex items-center justify-end gap-2",children:[e.jsx("button",{className:"px-2 py-1 bg-blue-600 text-white rounded text-sm",onClick:async()=>{var l,c;try{const n=await j.getPurchase(t.id),o=K(((l=n==null?void 0:n.data)==null?void 0:l.data)||(n==null?void 0:n.data)||n);h(o),E(o.supplierId||null),C(((c=o.supplier)==null?void 0:c.name)||"")}catch(n){console.error("Failed to load purchase",n),b.error("Failed to load purchase")}},children:"Edit"}),u&&e.jsx("button",{className:"px-2 py-1 bg-red-600 text-white rounded text-sm",onClick:async()=>{var l,c;if(window.confirm("Delete this draft purchase? This cannot be undone."))try{await j.deletePurchase(t.id),b.success("Draft purchase deleted"),await g()}catch(n){console.error(n),b.error(((c=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to delete purchase")}},children:"Delete"})]})]},t.id)})})]})}),r&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 mt-6 p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Edit Draft Purchase"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Edit purchase details created from upload"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"px-3 py-1 border rounded",onClick:async()=>{h(null),await g()},children:"Back to list"}),e.jsx("button",{className:"px-3 py-1 bg-green-600 text-white rounded",onClick:async()=>{var t,a;try{const s=S.map(o=>({...o}));for(let o=0;o<s.length;o++){const d=s[o];if(d.newEntry&&!d.productId){const L=`SKU${Date.now().toString().slice(-6)}${Math.floor(Math.random()*900+100)}`,U={code:L,name:d.name||`Product-${L}`,genericName:"",manufacturer:"",category:"",mrp:d.mrp||0,purchasePrice:d.unitPrice||0,sellingPrice:d.unitPrice||0,gstPercent:0,quantity:0,unit:"pcs"};try{const F=await G.createProduct(U),O=F.data||F,y=O||(O==null?void 0:O.data),J=(y==null?void 0:y.id)||((t=y==null?void 0:y.data)==null?void 0:t.id);J&&(s[o].productId=J,p(Z=>Z.map((z,ee)=>ee===o?{...z,productId:J}:z)),b.success(`Created product ${y.name||U.name}`))}catch(F){console.error("Failed to create product",F),b.error(`Failed to create product for item ${d.name}`)}}}const l={supplierId:B||null,invoiceNo:r.invoiceNo,invoiceDate:r.invoiceDate,notes:r.notes,subtotal:Number(r.subtotal||0),taxAmount:Number(r.taxAmount||0),roundOff:Number((r.roundOff??r.roundoff)||0),totalAmount:Number(r.totalAmount||0),items:s.map(o=>({name:o.name,productId:o.productId||void 0,quantity:Number(o.quantity||0),unitPrice:Number(o.unitPrice||0),mrp:Number(o.mrp||0),taxAmount:Number(o.taxAmount||0),amount:Number(o.amount||Number(o.quantity||0)*Number(o.unitPrice||0)),batchNumber:o.batchNumber||null,expiryDate:o.expiryDate||null}))};await j.updatePurchase(r.id,l),b.success("Purchase saved");const c=await j.getPurchase(r.id),n=K(((a=c==null?void 0:c.data)==null?void 0:a.data)||(c==null?void 0:c.data)||c);if(h(n),n&&Array.isArray(n.items)){const o=n.items.map(d=>({id:d.id,productId:d.productId,name:d.name,quantity:Number(d.quantity||0),unitPrice:Number(d.unitPrice||d.purchasePrice||0),mrp:Number(d.mrp||0),taxAmount:Number(d.taxAmount||0),amount:Number(d.amount||0),batchNumber:d.batchNumber||null,expiryDate:d.expiryDate?new Date(d.expiryDate).toISOString().slice(0,10):""}));p(o)}if(await g(),X){if(window.confirm("Publish now and update stock/ledger (Receive)?"))try{await j.receivePurchase(r.id),b.success("Purchase published and stock updated"),h(null),await g()}catch(o){console.error(o),b.error("Saved but failed to publish (receive)")}}else h(null)}catch(s){console.error(s),b.error("Failed to publish purchase")}},children:"Publish"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-3",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Invoice No"}),e.jsx("input",{className:"w-full p-2 border rounded",value:r.invoiceNo||"",onChange:t=>h(a=>({...a,invoiceNo:t.target.value}))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Invoice Date"}),e.jsx("input",{type:"date",lang:"en-GB",placeholder:"dd/mm/yyyy",className:"w-full p-2 border rounded",value:r.invoiceDate?new Date(r.invoiceDate).toISOString().slice(0,10):"",onChange:t=>h(a=>({...a,invoiceDate:t.target.value}))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Supplier (search)"}),e.jsx("input",{value:w,onChange:t=>{C(t.target.value),E(null)},className:"w-full p-2 border rounded",placeholder:"Search suppliers by name"}),_&&e.jsx("div",{className:"text-xs text-gray-500",children:"Searching..."}),$.length>0&&e.jsx("ul",{className:"bg-white border rounded mt-1 max-h-48 overflow-auto text-sm",children:$.map(t=>e.jsxs("li",{className:`p-2 hover:bg-gray-50 cursor-pointer ${B===t.id?"bg-gray-100":""}`,onClick:()=>{E(t.id),C(t.name),A([])},children:[t.name," ",t.phone?`· ${t.phone}`:""]},t.id))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Notes"}),e.jsx("textarea",{className:"w-full p-2 border rounded",value:r.notes||"",onChange:t=>h(a=>({...a,notes:t.target.value}))})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Items"}),e.jsx("div",{className:"overflow-x-auto overflow-y-auto max-h-[40vh]",children:e.jsxs("table",{className:"min-w-max w-full text-sm border",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Name"}),e.jsx("th",{className:"p-2",children:"Link Product"}),e.jsx("th",{className:"p-2",children:"Qty"}),e.jsx("th",{className:"p-2",children:"Unit Price"}),e.jsx("th",{className:"p-2",children:"MRP"}),e.jsx("th",{className:"p-2",children:"Batch"}),e.jsx("th",{className:"p-2",children:"Expiry"}),e.jsx("th",{className:"p-2",children:"Amount"})]})}),e.jsx("tbody",{children:Array.isArray(S)&&S.map((t,a)=>e.jsxs("tr",{className:"border-t",children:[e.jsxs("td",{className:"p-2 relative",children:[e.jsx("input",{className:"w-full p-1 border rounded",value:t.name||"",onChange:s=>p(l=>l.map((c,n)=>n===a?{...c,name:s.target.value}:c))}),e.jsx("div",{className:"mt-1 text-xs",children:e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!t.newEntry,onChange:s=>p(l=>l.map((c,n)=>n===a?{...c,newEntry:s.target.checked}:c))}),e.jsx("span",{children:"Mark as new product"})]})})]}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{className:"w-full p-1 border rounded",placeholder:"Search products",value:V[a]||"",onChange:s=>Y(a,s.target.value)}),H[a]&&e.jsx("div",{className:"text-xs text-gray-500",children:"Searching products..."}),q[a]&&q[a].length>0&&e.jsx("ul",{className:"absolute left-0 right-0 bg-white border mt-1 max-h-56 overflow-auto z-20 text-sm",children:q[a].map(s=>e.jsxs("li",{className:"p-2 hover:bg-gray-50 cursor-pointer",onClick:()=>{p(l=>l.map((c,n)=>n===a?{...c,productId:s.id}:c)),D(l=>({...l,[a]:[]})),M(l=>({...l,[a]:s.name}))},children:[s.name," ",s.genericName?`· ${s.genericName}`:""]},s.id))})]})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",min:0,className:"w-14 p-1 border rounded",value:String(t.quantity||0),onChange:s=>{const l=Number(s.target.value||0);p(c=>c.map((n,o)=>o===a?{...n,quantity:l,amount:+(l*Number(n.unitPrice||0)).toFixed(2)}:n))}})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",step:"0.01",min:0,className:"w-20 p-1 border rounded",value:String(t.unitPrice||0),onChange:s=>{const l=Number(s.target.value||0);p(c=>c.map((n,o)=>o===a?{...n,unitPrice:l,amount:+(Number(n.quantity||0)*l).toFixed(2)}:n))}})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",step:"0.01",min:0,className:"w-20 p-1 border rounded",value:String(t.mrp||0),onChange:s=>p(l=>l.map((c,n)=>n===a?{...c,mrp:Number(s.target.value||0)}:c))})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{className:"w-32 p-1 border rounded",value:t.batchNumber||"",onChange:s=>p(l=>l.map((c,n)=>n===a?{...c,batchNumber:s.target.value}:c)),placeholder:"batch"})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"date",lang:"en-GB",placeholder:"dd/mm/yyyy",className:"w-36 p-1 border rounded",value:t.expiryDate||"",onChange:s=>p(l=>l.map((c,n)=>n===a?{...c,expiryDate:s.target.value}:c))})}),e.jsx("td",{className:"p-2",children:e.jsx("input",{type:"number",step:"0.01",min:0,className:"w-20 p-1 border rounded",value:String(t.amount||0),onChange:s=>{const l=Number(s.target.value||0);p(c=>c.map((n,o)=>o===a?{...n,amount:l,unitPrice:Number(n.quantity||0)>0?+(l/Number(n.quantity||1)).toFixed(2):n.unitPrice}:n))}})})]},t.id||a))})]})})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm text-gray-600",children:"Totals"}),e.jsxs("div",{className:"p-3 border rounded",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:Number(r.subtotal||0).toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tax"}),e.jsx("span",{children:Number(r.taxAmount||0).toFixed(2)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Roundoff (adjustment)"}),e.jsx("input",{type:"number",step:"0.01",className:"w-24 p-1 border rounded text-right",value:String(r.roundOff??r.roundoff??0),onChange:t=>h(a=>({...a,roundOff:Number(t.target.value||0)}))})]}),e.jsxs("div",{className:"flex justify-between font-semibold mt-2",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:Number(r.totalAmount||0).toFixed(2)})]})]})]}),r.upload&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm text-gray-600 mb-2",children:"Parsed Invoice"}),e.jsx("div",{className:"border rounded p-2",children:W(r.upload)?e.jsx("img",{src:W(r.upload),alt:"invoice",className:"max-w-full h-auto rounded"}):r.upload.filename?e.jsx("img",{src:`/uploads/purchases/${r.upload.filename}`,alt:"invoice",className:"max-w-full h-auto rounded"}):e.jsx("pre",{className:"text-xs text-gray-600",children:r.upload.parsedJson?JSON.stringify(JSON.parse(r.upload.parsedJson),null,2):"No parsed data available"})})]})]})]})]})]})})})}function le(){return e.jsx(se,{})}export{le as PurchasesWithEdit,se as default};
