import{r,ai as ne,z as d,j as n,a0 as K}from"./index-BKdfnJ0H.js";import{u as H}from"./useMutation-C5UsUZj5.js";import{p as v}from"./purchaseService-C9FFvfeO.js";import{p as W}from"./pharmacyService-BAPmmZUZ.js";function Re(){const[q,M]=r.useState(null),[N,j]=r.useState(null),[c,I]=r.useState(null),[ce,oe]=r.useState(""),[ue,A]=r.useState(!0),[le,X]=r.useState(null),[w,ie]=r.useState(""),[de,D]=r.useState([]),[pe,k]=r.useState(!1),[me,fe]=r.useState({}),[Y,O]=r.useState(!1),[Z,L]=r.useState(!1),[i,h]=r.useState({name:"",code:"",category:"",mrp:0,purchasePrice:0,sellingPrice:0,gstPercent:12,quantity:0,unit:"pcs",expiryDate:"",manufacturer:""}),[C,$]=r.useState(null),[he,ge]=r.useState(!1),[ye,be]=r.useState({name:"",phone:"",email:"",address:"",gstNumber:"",notes:""}),[Se,U]=r.useState({}),[ve,F]=r.useState({}),x=r.useRef({}),[Ne,R]=r.useState([]),[xe,z]=r.useState(""),[Pe,Q]=r.useState(""),[we,E]=r.useState(0),[ee,V]=r.useState(0),[Ce,J]=r.useState(0),[je,Ie]=r.useState(!1),[B,g]=r.useState(!1),y=r.useRef(null),P=r.useRef({intervalId:null,timeoutId:null}),G=r.useRef(new Set),T=H({mutationFn:({form:e,signal:t})=>v.uploadInvoice(e,{signal:t,timeout:3e5}),onSuccess:e=>{const t=(e==null?void 0:e.data)||e||{},s=(t==null?void 0:t.data)||{},u=t.id||s.id||t.uploadId||s.uploadId||null;j(u);const o=t.parsedJson||s.parsedJson||t.parsed||s.parsed||null;let l=null;try{o&&(typeof o=="string"?l=JSON.parse(o):l=o)}catch{try{l=JSON.parse(JSON.stringify(o))}catch{l=null}}I(l),l?g(!1):(d.success("File uploaded. Parsing in background — waiting for results..."),u&&te(u))},onError:e=>{const t=e==null?void 0:e.response;if(t&&t.data){const s=t.data.message||t.data.error||"Upload failed",u=t.data.data||t.data.record||null;let o=null;try{if(u&&u.parsedJson){const l=u.parsedJson;o=typeof l=="string"?JSON.parse(l):l,j(u.id||N),I(o),d.error(`${s} — parsed preview available for review`);return}}catch{}d.error(s)}else d.error("Upload failed")}}),te=e=>{b(),g(!0);const t=Date.now(),s=setInterval(async()=>{try{const o=await v.getUpload(e),l=(o==null?void 0:o.data)||o,p=(l==null?void 0:l.data)||l;if(!p)return;const m=p.status;if(m==="PARSED"&&p.parsedJson){let f=null;try{f=typeof p.parsedJson=="string"?JSON.parse(p.parsedJson):p.parsedJson}catch{f=null}I(f),j(e),b(),g(!1);return}if(m==="FAILED"){d.error("Parsing failed on server"),b(),g(!1);return}if(m==="CANCELLED"){d("Upload cancelled"),b(),g(!1);return}if(Date.now()-t>3e5){d.error("Parsing timed out after 5 minutes"),b(),g(!1);return}}catch(o){console.error("Polling error",o)}},3e3),u=setTimeout(()=>{b(),g(!1)},305e3);P.current={intervalId:s,timeoutId:u}},b=()=>{try{P.current.intervalId&&clearInterval(P.current.intervalId),P.current.timeoutId&&clearTimeout(P.current.timeoutId)}catch{}P.current={intervalId:null,timeoutId:null}};H({mutationFn:({id:e,body:t})=>v.createFromUpload(e,t),onSuccess:async(e,t)=>{var o,l;const s=(e==null?void 0:e.data)||e||{},u=s||(s==null?void 0:s.data);d.success("Purchase created from upload");try{if((o=t==null?void 0:t.body)!=null&&o.createAndReceive){const p=u.id||((l=u==null?void 0:u.data)==null?void 0:l.id)||(s==null?void 0:s.id);p&&(await v.receivePurchase(p),d.success("Purchase published and stock updated"))}}catch{d.error("Created purchase but failed to publish/receive")}window.location.href="/pharmacy/purchases"},onError:()=>d.error("Failed to create purchase")});const ae=async()=>{if(!q)return d.error("Select a file");const e=new FormData;if(e.append("file",q),y.current)try{y.current.abort()}catch{}const t=new AbortController;y.current=t,g(!0),T.mutate({form:e,signal:t.signal},{onSettled:()=>{g(!1),y.current=null}})},re=async()=>{try{y.current&&y.current.abort()}catch{}if(g(!1),N)try{await v.cancelUpload(N),d.success("Upload cancelled")}catch{d.error("Failed to cancel upload on server")}else d("Upload request aborted")};r.useEffect(()=>{var e,t,s,u,o,l,p;if(c){R(c.items&&Array.isArray(c.items)?c.items.map(a=>({name:a.name||a.description||"Item",productId:a.productId||null,quantity:Number(a.quantity||1),unitPrice:Number(a.unitPrice||0),taxAmount:Number(a.taxAmount||0),amount:Number(a.amount||(a.quantity||1)*(a.unitPrice||0)),batchNumber:a.batchNumber||"",expiryDate:a.expiryDate?a.expiryDate.split?a.expiryDate.split("T")[0]:a.expiryDate:""})):[]),z(c.invoiceNo||""),Q(c.invoiceDate?c.invoiceDate.split("T")[0]:""),E(c.subtotal||((e=c.totals)==null?void 0:e.sub_total)||0);let m=c.taxAmount;if(!m&&Array.isArray(c.tax_summary)&&c.tax_summary.length){const a=c.tax_summary[0];m=Number(a.tax_amount||Number(a.sgst_amount||0)+Number(a.cgst_amount||0)||0)}V(m||0),J(c.totalAmount||((t=c.totals)==null?void 0:t.net_amount)||+(Number(c.subtotal||0)+Number(m||0)).toFixed(2));const f=((s=c.pharmacy_details)==null?void 0:s.name)||null;f&&(X({name:f,phone:((u=c.pharmacy_details)==null?void 0:u.phone)||"",email:((o=c.pharmacy_details)==null?void 0:o.email)||"",address:((l=c.pharmacy_details)==null?void 0:l.address)||"",gstNumber:((p=c.pharmacy_details)==null?void 0:p.gstin)||""}),(async()=>{try{const a=await v.getSuppliers(f),S=(a==null?void 0:a.data)||a;Array.isArray(S)&&S.length?A(!0):A(!1)}catch{A(!1)}})())}else R([]),z(""),Q(""),E(0),V(0),J(0)},[c]),r.useEffect(()=>{if(!c)return;const e=N?`draft-purchase-ready-${N}`:`draft-purchase-ready-${Date.now()}`;G.current.has(e)||(G.current.add(e),ne.add({id:e,title:"Draft Purchase Ready",message:c!=null&&c.invoiceNo?`Invoice ${c.invoiceNo} is ready for review.`:"A draft purchase is ready for review.",path:"/pharmacy/purchases",type:"purchase",unread:!0}))},[c,N]),r.useEffect(()=>{c&&d.success(e=>n.jsx("div",{className:"cursor-pointer",onClick:()=>{window.location.href="/pharmacy/purchases",d.dismiss(e.id)},children:"Draft purchase ready for invoice — check the draft purchase list"}),{duration:8e3})},[c]),r.useEffect(()=>{if(!w||w.length<2){D([]);return}k(!0);const e=setTimeout(()=>{v.getSuppliers(w).then(t=>{const s=t.data||t;D(Array.isArray(s)?s:[])}).catch(()=>D([])).finally(()=>k(!1))},350);return()=>clearTimeout(e)},[w]),r.useEffect(()=>()=>{b();try{y.current&&y.current.abort()}catch{}},[]);const _=(e,t,s)=>{R(u=>{const o=[...u];o[e]={...o[e],[t]:s};const l=Number(o[e].quantity||0),p=Number(o[e].unitPrice||0);o[e].amount=+(l*p).toFixed(2);const m=o.reduce((f,a)=>f+(Number(a.amount)||0),0);if(E(m),J(+(m+Number(ee||0)).toFixed(2)),t==="name"){const f=(s||"").toString();x.current[e]&&clearTimeout(x.current[e]),f.length>=2?(F(a=>({...a,[e]:!0})),x.current[e]=setTimeout(async()=>{try{const a=await W.getProducts({search:f,limit:10}),S=a.data||a;U(se=>({...se,[e]:Array.isArray(S)?S:[]}))}catch{U(S=>({...S,[e]:[]}))}finally{F(a=>({...a,[e]:!1}))}},300)):(U(a=>({...a,[e]:[]})),F(a=>({...a,[e]:!1})),x.current[e]&&(clearTimeout(x.current[e]),delete x.current[e]))}return o})};return n.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-sm",children:[n.jsx("h2",{className:"text-lg font-medium mb-4",children:"Upload Purchase Invoice"}),n.jsxs("div",{className:"mb-4",children:[n.jsx("input",{type:"file",onChange:e=>M(e.target.files[0])}),n.jsx("div",{className:"text-xs text-gray-600 mt-2",children:"Note: Invoice scanning can take a few minutes. Please wait until parsing completes."})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(K,{onClick:ae,loading:T.isLoading||B,children:"Upload & Parse"}),(T.isLoading||B)&&n.jsx("button",{className:"px-3 py-1 bg-red-600 text-white rounded text-sm",onClick:re,children:"Cancel Upload"})]}),n.jsx(K,{variant:"secondary",onClick:()=>M(null),children:"Reset"})]}),Z&&n.jsx("div",{className:"fixed inset-0 bg-black/40 z-40 flex items-center justify-center",children:n.jsxs("div",{className:"bg-white p-6 rounded shadow-lg w-96",children:[n.jsx("h3",{className:"text-lg font-medium mb-3",children:"Create Product"}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Name",value:i.name,onChange:e=>h(t=>({...t,name:e.target.value}))}),n.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Code / SKU",value:i.code,onChange:e=>h(t=>({...t,code:e.target.value}))}),n.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Category",value:i.category,onChange:e=>h(t=>({...t,category:e.target.value}))}),n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsx("input",{type:"number",min:"0",step:"0.01",className:"p-2 border rounded",placeholder:"MRP",value:i.mrp,onChange:e=>h(t=>({...t,mrp:Number(e.target.value)}))}),n.jsx("input",{type:"number",min:"0",step:"0.01",className:"p-2 border rounded",placeholder:"Purchase Price",value:i.purchasePrice,onChange:e=>h(t=>({...t,purchasePrice:Number(e.target.value)}))}),n.jsx("input",{type:"number",min:"0",step:"0.01",className:"p-2 border rounded",placeholder:"Selling Price",value:i.sellingPrice,onChange:e=>h(t=>({...t,sellingPrice:Number(e.target.value)}))})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[n.jsx("input",{type:"number",min:"0",className:"p-2 border rounded",placeholder:"GST %",value:i.gstPercent,onChange:e=>h(t=>({...t,gstPercent:Number(e.target.value)}))}),n.jsx("input",{type:"number",min:"0",className:"p-2 border rounded",placeholder:"Quantity",value:i.quantity,onChange:e=>h(t=>({...t,quantity:Number(e.target.value)}))}),n.jsx("input",{className:"p-2 border rounded",placeholder:"Unit",value:i.unit,onChange:e=>h(t=>({...t,unit:e.target.value}))})]}),n.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Manufacturer",value:i.manufacturer,onChange:e=>h(t=>({...t,manufacturer:e.target.value}))}),n.jsx("input",{className:"w-full p-2 border rounded",placeholder:"Expiry Date",type:"date",value:i.expiryDate,onChange:e=>h(t=>({...t,expiryDate:e.target.value}))})]}),n.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[n.jsx("button",{className:"px-3 py-1 border rounded",onClick:()=>{L(!1),$(null)},children:"Cancel"}),n.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded",disabled:Y,onClick:async()=>{try{O(!0);const e={code:i.code,name:i.name,genericName:"",manufacturer:i.manufacturer,category:i.category,mrp:i.mrp,purchasePrice:i.purchasePrice,sellingPrice:i.sellingPrice,gstPercent:i.gstPercent,quantity:i.quantity,unit:i.unit,batchNumber:null,expiryDate:i.expiryDate||null},t=await W.createProduct(e),s=t.data||t,u=s||(s==null?void 0:s.data);C!==null&&(_(C,"productId",u.id||(u==null?void 0:u.id)),_(C,"name",u.name||i.name),_(C,"unitPrice",u.purchasePrice||u.sellingPrice||0)),d.success("Product created"),L(!1),$(null)}catch{d.error("Failed to create product")}finally{O(!1)}},children:"Create Product"})]})]})})]})}export{Re as default};
