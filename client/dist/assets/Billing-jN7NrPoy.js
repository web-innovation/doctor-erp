import{u as je,I as Ne,r as o,b as fe,J as K,p as F,j as e,L as be,y as ve,K as we,M as Pe,N as Ce,v as Se,d as Te,a5 as $,ak as W,O as Ae,P as De,Q as J,z as h,D as X}from"./index-DfbFSgDY.js";import{u as Y}from"./useMutation-bt9QuOne.js";import{b as I}from"./billingService-XoA_pl0S.js";import{a as Fe}from"./printTemplates-BEyV9waS.js";const Z={pending:"bg-yellow-100 text-yellow-800",partial:"bg-blue-100 text-blue-800",paid:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"},Ie=[{value:"",label:"All Status"},{value:"pending",label:"Pending"},{value:"partial",label:"Partial"},{value:"paid",label:"Paid"},{value:"cancelled",label:"Cancelled"}],ee=[0,5,10,12,18,20,30];function Re(){var Q,z,L,_,V,H;const te=je(),P=Ne(),[y,se]=o.useState(""),[x,g]=o.useState(1),[C,ae]=o.useState(!1),[i,k]=o.useState({status:"",startDate:"",endDate:""}),[ne,j]=o.useState(!1),[s,p]=o.useState(null),[re,N]=o.useState(!1),[le,B]=o.useState(null),f=10,{register:b,handleSubmit:ie,reset:S,formState:{errors:v}}=fe(),de=K("billing:create",["SUPER_ADMIN","DOCTOR","ACCOUNTANT","PHARMACIST","RECEPTIONIST"]),O=K("billing:edit",["SUPER_ADMIN","DOCTOR","ACCOUNTANT","PHARMACIST","RECEPTIONIST"]),{data:d,isLoading:ce}=F({queryKey:["bills",x,f,y,i],queryFn:()=>I.getBills({page:x,limit:f,search:y,...i}),placeholderData:t=>t}),{data:oe}=F({queryKey:["clinic-settings"],queryFn:()=>X.getClinicSettings()}),{data:xe}=F({queryKey:["print-templates"],queryFn:()=>X.getPrintTemplates()}),M=(d==null?void 0:d.data)||[],T=((Q=d==null?void 0:d.pagination)==null?void 0:Q.totalPages)||1,R=((z=d==null?void 0:d.pagination)==null?void 0:z.total)||0,A=Y({mutationFn:({id:t,paymentData:a})=>I.recordPayment(t,a),onSuccess:()=>{h.success("Payment recorded successfully"),P.invalidateQueries(["bills"]),j(!1),p(null),S()},onError:t=>{var a,n;h.error(((n=(a=t.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to record payment")}}),me=Y({mutationFn:({id:t,payload:a})=>I.updateBill(t,a),onSuccess:()=>{h.success("GST updated"),P.invalidateQueries(["bills"]),s!=null&&s.id&&P.invalidateQueries(["bill",s.id])},onError:t=>{var a,n;h.error(((n=(a=t.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to update GST")},onSettled:()=>B(null)}),ue=t=>{se(t.target.value),g(1)},D=(t,a)=>{k(n=>({...n,[t]:a})),g(1)},pe=()=>{k({status:"",startDate:"",endDate:""}),g(1)},E=t=>{p(t),j(!0)},ge=t=>{p(t),N(!0)},q=t=>{const a=window.open("","_blank");if(!a){h.error("Please allow popups to print");return}const n=Fe(t,oe||{},xe||{});a.document.write(n),a.document.close(),a.onload=()=>a.print()},he=t=>{s&&A.mutate({id:s.id,paymentData:{amount:parseFloat(t.amount),method:t.method,reference:t.reference,notes:t.notes}})},U=t=>t?new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}):"-",l=t=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:0}).format(t||0),c=t=>t.dueAmount||0,w=t=>{const a=Number((t==null?void 0:t.subtotal)||0)-Number((t==null?void 0:t.discountAmount)||0),n=Number((t==null?void 0:t.taxAmount)||0);if(a<=0||n<=0)return 0;const m=Math.round(n/a*100*100)/100,u=ee.find(r=>Number(r)===Number(m));return u!==void 0?u:0},ye=(t,a)=>{const n=Number(a||0),m=Number((t==null?void 0:t.discountPercent)||0)>0,u={notes:(t==null?void 0:t.notes)||"",doctorId:(t==null?void 0:t.doctorId)||void 0,type:(t==null?void 0:t.type)||void 0,discountType:m?"PERCENTAGE":"AMOUNT",discount:Number(m?(t==null?void 0:t.discountPercent)||0:(t==null?void 0:t.discountAmount)||0),taxConfig:{gstRate:n},items:((t==null?void 0:t.items)||[]).map(r=>({description:r.description,quantity:Number(r.quantity)||1,unitPrice:Number(r.unitPrice)||0,gstPercent:Number(r.gstPercent)||0,productId:r.productId||null,labId:r.labId||null,labTestId:r.labTestId||null,doctorId:r.doctorId||null}))};B(t.id),me.mutate({id:t.id,payload:u})},G=i.status||i.startDate||i.endDate;return e.jsxs("div",{className:"min-h-screen bg-gray-50 p-6",children:[e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Billing"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Manage invoices and payments"})]}),de&&e.jsxs(be,{to:"/billing/new",className:"inline-flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition",children:[e.jsx(ve,{}),"New Bill"]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(we,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",value:y,onChange:ue,placeholder:"Search by bill number or patient name...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"})]}),e.jsx("select",{value:i.status,onChange:t=>D("status",t.target.value),className:"px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:Ie.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsxs("button",{onClick:()=>ae(!C),className:`inline-flex items-center gap-2 px-4 py-2.5 border rounded-lg font-medium transition ${C||G?"border-blue-500 text-blue-600 bg-blue-50":"border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:[e.jsx(Pe,{}),"Date Filter",(i.startDate||i.endDate)&&e.jsx("span",{className:"bg-blue-600 text-white text-xs px-1.5 py-0.5 rounded-full",children:"1"})]})]}),C&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"From Date"}),e.jsx("input",{type:"date",lang:"en-GB",value:i.startDate,onChange:t=>D("startDate",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"To Date"}),e.jsx("input",{type:"date",lang:"en-GB",value:i.endDate,onChange:t=>D("endDate",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{onClick:pe,className:"flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-800 transition",children:[e.jsx(Ce,{}),"Clear Filters"]})})]})})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden",children:ce?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):M.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500",children:[e.jsx(Se,{className:"text-4xl mb-4"}),e.jsx("p",{className:"font-medium",children:"No bills found"}),e.jsx("p",{className:"text-sm mt-1",children:y||G?"Try adjusting your search or filters":"Create your first bill to get started"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Bill No"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Patient"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Amount"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"GST"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:M.map(t=>{var a,n,m,u;return e.jsxs("tr",{className:"hover:bg-gray-50 transition",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"text-sm font-medium text-blue-600",children:t.billNo||t.id.slice(-8).toUpperCase()})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-600",children:U(t.createdAt)})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:((a=t.patient)==null?void 0:a.name)||"Unknown Patient"}),((n=t.patient)==null?void 0:n.phone)&&e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:t.patient.phone})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:l(t.totalAmount)}),t.status!=="paid"&&c(t)>0&&e.jsxs("p",{className:"text-xs text-red-600 mt-0.5",children:["Due: ",l(c(t))]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:O?e.jsx("select",{value:w(t),onChange:r=>ye(t,r.target.value),disabled:le===t.id,className:"px-2 py-1.5 text-sm border border-gray-300 rounded-lg bg-white disabled:opacity-60",children:ee.map(r=>e.jsxs("option",{value:r,children:[r,"%"]},r))}):e.jsxs("span",{className:"text-sm text-gray-600",children:[w(t),"%"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex px-2.5 py-1 rounded-full text-xs font-medium capitalize ${Z[(m=t.paymentStatus)==null?void 0:m.toLowerCase()]||Z.pending}`,children:((u=t.paymentStatus)==null?void 0:u.toLowerCase())||"pending"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>ge(t),className:"p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition",title:"View",children:e.jsx(Te,{})}),e.jsx("button",{onClick:()=>q(t),className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition",title:"Print",children:e.jsx($,{})}),t.status!=="paid"&&t.status!=="cancelled"&&e.jsxs("button",{onClick:()=>E(t),className:"inline-flex items-center gap-1 px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-sm font-medium hover:bg-green-100 transition",title:"Record Payment",children:[e.jsx(W,{className:"text-xs"}),"Pay"]})]})})]},t.id)})})]})}),e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-t border-gray-100",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Showing"," ",e.jsx("span",{className:"font-medium",children:(x-1)*f+1})," ","to"," ",e.jsx("span",{className:"font-medium",children:Math.min(x*f,R)})," ","of ",e.jsx("span",{className:"font-medium",children:R})," bills"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>g(t=>Math.max(1,t-1)),disabled:x===1,className:"p-2 rounded-lg border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition",children:e.jsx(Ae,{className:"text-gray-600"})}),e.jsxs("span",{className:"text-sm text-gray-600",children:["Page ",x," of ",T]}),e.jsx("button",{onClick:()=>g(t=>Math.min(T,t+1)),disabled:x===T,className:"p-2 rounded-lg border border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition",children:e.jsx(De,{className:"text-gray-600"})})]})]})]})})]}),e.jsx(J,{isOpen:ne,onClose:()=>{j(!1),p(null),S()},title:"Record Payment",size:"md",children:s&&e.jsxs("form",{onSubmit:ie(he),className:"space-y-4",children:[e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Bill Number"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.billNo||s.id.slice(-8).toUpperCase()})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Balance Due"}),e.jsx("p",{className:"font-medium text-red-600",children:l(c(s))})]})]})}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Amount (â‚¹) ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",...b("amount",{required:"Amount is required",min:{value:1,message:"Amount must be at least 1"},max:{value:c(s),message:`Amount cannot exceed ${l(c(s))}`}}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter amount",defaultValue:c(s)}),v.amount&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.amount.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Method ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{...b("method",{required:"Payment method is required"}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select method"}),e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"netbanking",children:"Net Banking"}),e.jsx("option",{value:"insurance",children:"Insurance"}),e.jsx("option",{value:"other",children:"Other"})]}),v.method&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:v.method.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference / Transaction ID"}),e.jsx("input",{...b("reference"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter reference number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{...b("notes"),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",placeholder:"Optional payment notes"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100",children:[e.jsx("button",{type:"button",onClick:()=>{j(!1),p(null),S()},className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:A.isPending,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50",children:A.isPending?"Recording...":"Record Payment"})]})]})}),e.jsx(J,{isOpen:re,onClose:()=>{N(!1),p(null)},title:"Bill Details",size:"lg",children:s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-start pb-4 border-b border-gray-100",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Bill Number"}),e.jsx("p",{className:"font-bold text-lg text-gray-900",children:s.billNo||s.id.slice(-8).toUpperCase()})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Date"}),e.jsx("p",{className:"font-medium text-gray-900",children:U(s.createdAt)})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"Patient"}),e.jsx("p",{className:"font-medium text-gray-900",children:((L=s.patient)==null?void 0:L.name)||"Unknown Patient"}),((_=s.patient)==null?void 0:_.phone)&&e.jsx("p",{className:"text-sm text-gray-600",children:s.patient.phone}),((V=s.doctor)==null?void 0:V.name)&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Doctor: Dr. ",s.doctor.name]})]}),s.items&&s.items.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Items"}),e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-gray-600",children:"Description"}),e.jsx("th",{className:"px-4 py-2 text-center text-gray-600",children:"Qty"}),e.jsx("th",{className:"px-4 py-2 text-right text-gray-600",children:"Price"}),e.jsx("th",{className:"px-4 py-2 text-right text-gray-600",children:"Total"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:s.items.map((t,a)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-gray-900",children:t.description}),e.jsx("td",{className:"px-4 py-2 text-center text-gray-600",children:t.quantity}),e.jsx("td",{className:"px-4 py-2 text-right text-gray-600",children:l(t.unitPrice)}),e.jsx("td",{className:"px-4 py-2 text-right font-medium text-gray-900",children:l(t.quantity*t.unitPrice)})]},a))})]})})]}),e.jsxs("div",{className:"border-t border-gray-100 pt-4 space-y-2",children:[s.discount>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Discount"}),e.jsxs("span",{className:"text-red-600",children:["-",l(s.discount)]})]}),w(s)>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-500",children:["Tax (",w(s),"%)"]}),e.jsx("span",{className:"text-gray-600",children:l(s.taxAmount||0)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{className:"text-gray-900",children:"Total Amount"}),e.jsx("span",{className:"text-gray-900",children:l(s.totalAmount)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Paid"}),e.jsx("span",{className:"text-green-600",children:l(((H=s.payments)==null?void 0:H.reduce((t,a)=>t+a.amount,0))||0)})]}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{className:"text-gray-700",children:"Balance Due"}),e.jsx("span",{className:c(s)>0?"text-red-600":"text-green-600",children:l(c(s))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100",children:[e.jsxs("button",{onClick:()=>q(s),className:"inline-flex items-center gap-2 px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:[e.jsx($,{}),"Print"]}),O&&e.jsx("button",{onClick:()=>{N(!1),te(`/billing/${s.id}/edit`)},className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:"Edit"}),s.status!=="paid"&&s.status!=="cancelled"&&e.jsxs("button",{onClick:()=>{N(!1),E(s)},className:"inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition",children:[e.jsx(W,{}),"Record Payment"]})]})]})})]})}export{Re as default};
