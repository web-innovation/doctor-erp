import{W as ke,u as Le,r as n,j as e,X as Fe,K as d,Q as te,S as le,P as Te,Y as k,x as ie,E as Ue,D as Pe,Z as Ee,V as p,_ as De,y as Re,$ as Ie,T as Me,U as L,a0 as Oe}from"./index-CA1lxKIy.js";import{a as o}from"./adminService-DIeyh_pm.js";const _e=()=>{var O,B,$,_,X,q,G,V,H,K,Y,Q,W,Z,z,J,ee,se,ae;const{id:u}=ke(),F=Le(),[i,re]=n.useState(null),[ne,T]=n.useState(!0),[ce,b]=n.useState(!1),[de,N]=n.useState(!1),[oe,w]=n.useState(!1),[me,C]=n.useState(!1),[j,S]=n.useState(null),[y,A]=n.useState({name:"",phone:"",address:""}),[m,g]=n.useState({name:"",email:"",phone:"",role:"RECEPTIONIST",password:""}),[x,v]=n.useState({invoiceUploadLimit:{monthly:"",yearly:""},staffLimit:"",disabledPermissionsText:""}),[xe,U]=n.useState(!1),[P,pe]=n.useState("30"),[ue,E]=n.useState(!1),[D,he]=n.useState(null),[R,I]=n.useState(!1),[c,fe]=n.useState(null),ye=[{value:"DOCTOR",label:"Doctor"},{value:"RECEPTIONIST",label:"Receptionist"},{value:"NURSE",label:"Nurse"},{value:"PHARMACIST",label:"Pharmacist"},{value:"LAB_TECHNICIAN",label:"Lab Technician"},{value:"ACCOUNTANT",label:"Accountant"}];n.useEffect(()=>{h()},[u]);const h=async()=>{var s,a;try{T(!0);const l=await o.getClinic(u);re(l);const t=l.accessControls||{};v({invoiceUploadLimit:{monthly:((s=t==null?void 0:t.invoiceUploadLimit)==null?void 0:s.monthly)??"",yearly:((a=t==null?void 0:t.invoiceUploadLimit)==null?void 0:a.yearly)??""},staffLimit:(t==null?void 0:t.staffLimit)??"",disabledPermissionsText:Array.isArray(t==null?void 0:t.disabledPermissions)?t.disabledPermissions.join(`
`):""}),A({name:l.name,phone:l.phone||"",address:l.address||""})}catch(l){console.error("Failed to fetch clinic:",l),F("/admin/clinics")}finally{T(!1)}},ge=async s=>{var a,l;s.preventDefault();try{await o.updateClinic(u,y),b(!1),h()}catch(t){console.error("Failed to update clinic:",t),alert(((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to update clinic")}},je=async s=>{var a,l;s.preventDefault();try{const t=await o.addStaffToClinic(u,m);N(!1),g({name:"",email:"",phone:"",role:"RECEPTIONIST",password:""}),h(),t.tempPassword?alert(`Staff added successfully! Temporary password: ${t.tempPassword}`):alert("Staff added successfully!")}catch(t){console.error("Failed to add staff:",t),alert(((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to add staff member")}},ve=async()=>{var s,a;if(j)try{await o.removeStaffFromClinic(u,j.id),w(!1),S(null),h()}catch(l){console.error("Failed to remove staff:",l),alert(((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to remove staff member")}},be=async s=>{var a,l;try{await o.toggleUserStatus(s.id),h()}catch(t){console.error("Failed to toggle staff status:",t),alert(((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to update staff status")}},Ne=async()=>{var s,a;try{i.isActive?await o.blockClinic(u):await o.unblockClinic(u),C(!1),h()}catch(l){console.error("Failed to update clinic status:",l),alert(((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to update clinic status")}},we=async s=>{var a,l;if(confirm(`Reset password for ${s.name}? A new password will be set.`))try{const t=await o.resetUserPassword(s.id);alert(`Password reset successfully! ${t.tempPassword?`New password: ${t.tempPassword}`:""}`)}catch(t){console.error("Failed to reset password:",t),alert(((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to reset password")}},Ce=async()=>{var s,a;try{U(!0);const l=x.disabledPermissionsText.split(/[\n,]+/).map(t=>t.trim()).filter(Boolean);await o.updateClinicAccessControls(u,{invoiceUploadLimit:{monthly:x.invoiceUploadLimit.monthly===""?null:Number(x.invoiceUploadLimit.monthly),yearly:x.invoiceUploadLimit.yearly===""?null:Number(x.invoiceUploadLimit.yearly)},staffLimit:x.staffLimit===""?null:Number(x.staffLimit),disabledPermissions:l}),alert("Access controls updated"),h()}catch(l){console.error("Failed to save controls:",l),alert(((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to update controls")}finally{U(!1)}},Se=async()=>{var a,l;const s=Number(P);if(!Number.isFinite(s)||s<=0){alert("Please enter valid extension days");return}try{E(!0),await o.extendClinicSubscription(u,{days:Math.floor(s)}),alert(`Subscription extended by ${Math.floor(s)} days`),h()}catch(t){console.error("Failed to extend subscription:",t),alert(((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to extend subscription")}finally{E(!1)}},M=async(s=!1)=>{var a,l;if(!D){alert("Please select a CSV or XLSX file");return}try{I(!0);const t=new FormData;t.append("file",D);const f=await o.importClinicSetup(u,t,{dryRun:s});fe((f==null?void 0:f.data)||null),alert(s?"Dry run completed":"Clinic setup import completed"),h()}catch(t){console.error("Failed to import setup:",t),alert(((l=(a=t.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to import setup")}finally{I(!1)}},Ae=async()=>{var s,a;try{const l=await o.downloadSetupTemplate(),t=window.URL.createObjectURL(new Blob([l],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})),f=document.createElement("a");f.href=t,f.setAttribute("download","clinic_setup_template.xlsx"),document.body.appendChild(f),f.click(),f.remove(),window.URL.revokeObjectURL(t)}catch(l){console.error("Template download failed:",l),alert(((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to download template")}};if(ne)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"})});if(!i)return null;const r=((O=i==null?void 0:i.accessControls)==null?void 0:O.subscriptionSnapshot)||null;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:()=>F("/admin/clinics"),className:"p-2 hover:bg-gray-100 rounded-lg",children:e.jsx(Fe,{className:"text-xl"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:i.name}),e.jsxs("p",{className:"text-gray-600",children:["Created on ",new Date(i.createdAt).toLocaleDateString("en-GB")]})]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-sm ${i.isActive?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:i.isActive?"Active":"Blocked"}),e.jsx(d,{variant:i.isActive?"danger":"primary",onClick:()=>C(!0),children:i.isActive?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"mr-2"})," Block"]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"mr-2"})," Unblock"]})}),e.jsxs(d,{onClick:()=>b(!0),children:[e.jsx(Te,{className:"mr-2"})," Edit"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(k,{title:"Total Users",value:((B=i.users)==null?void 0:B.length)||(($=i._count)==null?void 0:$.users)||0,icon:ie,color:"blue"}),e.jsx(k,{title:"Total Patients",value:((_=i.stats)==null?void 0:_.totalPatients)||((X=i._count)==null?void 0:X.patients)||0,icon:ie,color:"green"}),e.jsx(k,{title:"Total Appointments",value:((q=i.stats)==null?void 0:q.totalAppointments)||((G=i._count)==null?void 0:G.appointments)||0,icon:Ue,color:"purple"}),e.jsx(k,{title:"Total Revenue",value:`â‚¹${(((V=i.stats)==null?void 0:V.totalRevenue)||0).toLocaleString()}`,icon:Pe,color:"orange"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Clinic Information"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Phone"}),e.jsx("p",{className:"mt-1 text-gray-900",children:i.phone||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Email"}),e.jsx("p",{className:"mt-1 text-gray-900",children:i.email||"-"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Address"}),e.jsx("p",{className:"mt-1 text-gray-900",children:[i.address,i.city,i.state,i.pincode].filter(Boolean).join(", ")||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"GST Number"}),e.jsx("p",{className:"mt-1 text-gray-900",children:i.gstNumber||"-"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"License Number"}),e.jsx("p",{className:"mt-1 text-gray-900",children:i.licenseNumber||"-"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 space-y-5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ee,{className:"text-purple-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Clinic Access Controls"})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Plan"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:(r==null?void 0:r.planCode)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Status"}),e.jsx("span",{className:`inline-flex mt-1 px-2 py-1 rounded-full text-xs font-medium ${(r==null?void 0:r.status)==="ACTIVE"?"bg-green-100 text-green-700":(r==null?void 0:r.status)==="TRIAL"?"bg-blue-100 text-blue-700":(r==null?void 0:r.status)==="GRACE"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700"}`,children:(r==null?void 0:r.status)||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Expires On"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:r!=null&&r.expiresAt?new Date(r.expiresAt).toLocaleDateString("en-GB"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Days To Expiry"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:(r==null?void 0:r.daysToExpiry)??"-"})]})]}),e.jsxs("div",{className:"mt-4 flex flex-col sm:flex-row sm:items-end gap-3",children:[e.jsx(p,{type:"number",min:"1",label:"Extend Subscription (Days)",value:P,onChange:s=>pe(s.target.value)}),e.jsx(d,{onClick:Se,loading:ue,children:"Extend Subscription"})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Use this when clinic is in grace period or expired. Extension immediately updates expiry date."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(p,{type:"number",min:"0",label:"Monthly Invoice Upload Limit",value:x.invoiceUploadLimit.monthly,onChange:s=>v(a=>({...a,invoiceUploadLimit:{...a.invoiceUploadLimit,monthly:s.target.value}}))}),e.jsx(p,{type:"number",min:"0",label:"Yearly Invoice Upload Limit",value:x.invoiceUploadLimit.yearly,onChange:s=>v(a=>({...a,invoiceUploadLimit:{...a.invoiceUploadLimit,yearly:s.target.value}}))}),e.jsx(p,{type:"number",min:"0",label:"Staff Limit",value:x.staffLimit,onChange:s=>v(a=>({...a,staffLimit:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Disabled Permissions (one per line or comma separated)"}),e.jsx("textarea",{className:"w-full rounded-lg border border-gray-300 p-3 text-sm",rows:4,placeholder:"Example: billing:create",value:x.disabledPermissionsText,onChange:s=>v(a=>({...a,disabledPermissionsText:s.target.value}))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{onClick:Ce,loading:xe,children:"Save Controls"}),e.jsx("button",{type:"button",onClick:Ae,className:"inline-flex items-center px-4 py-2 border rounded-lg text-sm hover:bg-gray-50",children:"Download Setup Template"})]}),e.jsxs("div",{className:"border-t pt-5",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:"One-click Clinic Setup Import"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Upload the template spreadsheet (XLSX) to create staff, pharmacy products, agents, labs, and lab tests."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[e.jsx("input",{type:"file",accept:".csv,text/csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",onChange:s=>{var a;return he(((a=s.target.files)==null?void 0:a[0])||null)}}),e.jsx(d,{variant:"outline",onClick:()=>M(!0),loading:R,children:"Dry Run"}),e.jsxs(d,{onClick:()=>M(!1),loading:R,children:[e.jsx(De,{className:"mr-2"})," Import Setup"]})]}),(c==null?void 0:c.summary)&&e.jsxs("div",{className:"mt-4 text-sm bg-gray-50 border rounded-lg p-3 space-y-1",children:[e.jsxs("p",{children:["Rows: ",c.summary.rows]}),e.jsxs("p",{children:["Staff created/updated: ",((H=c.summary.staff)==null?void 0:H.created)||0,"/",((K=c.summary.staff)==null?void 0:K.updated)||0]}),e.jsxs("p",{children:["Pharmacy created/updated: ",((Y=c.summary.pharmacy)==null?void 0:Y.created)||0,"/",((Q=c.summary.pharmacy)==null?void 0:Q.updated)||0]}),e.jsxs("p",{children:["Labs created/updated: ",((W=c.summary.labs)==null?void 0:W.created)||0,"/",((Z=c.summary.labs)==null?void 0:Z.updated)||0]}),e.jsxs("p",{children:["Lab tests created/updated: ",((z=c.summary.labTests)==null?void 0:z.created)||0,"/",((J=c.summary.labTests)==null?void 0:J.updated)||0]}),e.jsxs("p",{children:["Agents created/updated: ",((ee=c.summary.agents)==null?void 0:ee.created)||0,"/",((se=c.summary.agents)==null?void 0:se.updated)||0]}),(c.summary.errors||[]).length>0&&e.jsxs("p",{className:"text-red-600",children:["Errors: ",(c.summary.errors||[]).slice(0,3).join(" | ")]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Staff Members"}),e.jsxs(d,{onClick:()=>N(!0),children:[e.jsx(Re,{className:"mr-2"})," Add Staff"]})]}),((ae=i.users)==null?void 0:ae.length)>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Phone"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Role"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:i.users.map(s=>{var a;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center",children:e.jsx("span",{className:"text-purple-600 font-medium text-sm",children:((a=s.name)==null?void 0:a.charAt(0))||"?"})}),e.jsx("span",{className:"ml-3 font-medium text-gray-900",children:s.name})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-gray-600",children:s.email}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-gray-600",children:s.phone||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.role==="DOCTOR"?"bg-blue-100 text-blue-800":s.role==="ADMIN"?"bg-purple-100 text-purple-800":"bg-gray-100 text-gray-800"}`,children:s.role})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.isActive?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.isActive?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:()=>we(s),className:"text-blue-600 hover:text-blue-800 p-1",title:"Reset Password",children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>be(s),className:`p-1 ${s.isActive?"text-orange-600 hover:text-orange-800":"text-green-600 hover:text-green-800"}`,title:s.isActive?"Deactivate":"Activate",children:s.isActive?e.jsx(te,{className:"h-4 w-4"}):e.jsx(le,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>{S(s),w(!0)},className:"text-red-600 hover:text-red-800 p-1",title:"Remove Staff",children:e.jsx(Me,{className:"h-4 w-4"})})]})})]},s.id)})})]})}):e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No staff members found"})]}),e.jsx(L,{isOpen:ce,onClose:()=>b(!1),title:"Edit Clinic",children:e.jsxs("form",{onSubmit:ge,className:"space-y-4",children:[e.jsx(p,{label:"Clinic Name",value:y.name,onChange:s=>A({...y,name:s.target.value}),required:!0}),e.jsx(p,{label:"Phone",value:y.phone,onChange:s=>A({...y,phone:s.target.value})}),e.jsx(p,{label:"Address",value:y.address,onChange:s=>A({...y,address:s.target.value})}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>b(!1),children:"Cancel"}),e.jsx(d,{type:"submit",children:"Update Clinic"})]})]})}),e.jsx(L,{isOpen:de,onClose:()=>N(!1),title:"Add Staff Member",children:e.jsxs("form",{onSubmit:je,className:"space-y-4",children:[e.jsx(p,{label:"Full Name",value:m.name,onChange:s=>g({...m,name:s.target.value}),required:!0}),e.jsx(p,{label:"Email",type:"email",value:m.email,onChange:s=>g({...m,email:s.target.value}),required:!0}),e.jsx(p,{label:"Phone",value:m.phone,onChange:s=>g({...m,phone:s.target.value}),required:!0}),e.jsx(Oe,{label:"Role",options:ye,value:m.role,onChange:s=>g({...m,role:s.target.value})}),e.jsx(p,{label:"Password (leave empty for auto-generated)",type:"password",value:m.password,onChange:s=>g({...m,password:s.target.value}),placeholder:"Leave empty for default: password123"}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>N(!1),children:"Cancel"}),e.jsx(d,{type:"submit",children:"Add Staff"})]})]})}),e.jsx(L,{isOpen:oe,onClose:()=>{w(!1),S(null)},title:"Remove Staff Member",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-gray-600",children:["Are you sure you want to remove ",e.jsx("strong",{children:j==null?void 0:j.name})," from this clinic? They will be deactivated and unable to access the system."]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(d,{variant:"outline",onClick:()=>{w(!1),S(null)},children:"Cancel"}),e.jsx(d,{variant:"danger",onClick:ve,children:"Remove Staff"})]})]})}),e.jsx(L,{isOpen:me,onClose:()=>C(!1),title:i.isActive?"Block Clinic":"Unblock Clinic",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-600",children:i.isActive?`Are you sure you want to block "${i.name}"? All users will be deactivated and unable to access the system.`:`Are you sure you want to unblock "${i.name}"? All users will be reactivated and able to access the system.`}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx(d,{variant:"outline",onClick:()=>C(!1),children:"Cancel"}),e.jsx(d,{variant:i.isActive?"danger":"primary",onClick:Ne,children:i.isActive?"Block Clinic":"Unblock Clinic"})]})]})})]})};export{_e as default};
